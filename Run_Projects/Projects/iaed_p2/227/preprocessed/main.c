/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "custom_types.h"
#include "game_linked_list.h"
#include "team_linked_list.h"
#include "game_hash_table.h"
#include "team_hash_table.h"


int NL = 0;
typedef struct data
{
  GameList Gamesdll;
  TeamList Teamsdll;
  GameHtable gamesHT;
  TeamHtable teamsHT;
} *Data;
Data data_init()
{
  Data data = malloc(sizeof(struct data));
  data->Gamesdll = gameListInit();
  data->Teamsdll = teamListInit();
  data->gamesHT = gameHtInit(1000);
  data->teamsHT = teamHtInit(1000);
  return data;
}

Data adicionaJogo(Data data)
{
  char name[1024];
  char team1[1024];
  char team2[1024];
  int scoreTeam1;
  int scoreTeam2;
  int h_name;
  int h_team1;
  int h_team2;
  GameLink linkG;
  TeamHT_node team1Node;
  TeamHT_node team2Node;
  NL++;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  for (int team1_index = 0; team1_index < 10; team1_index++)
  {
    team1[team1_index] = new_sym_var(sizeof(char) * 8);
  }

  team1[10 - 1] = '\0';
  for (int team2_index = 0; team2_index < 10; team2_index++)
  {
    team2[team2_index] = new_sym_var(sizeof(char) * 8);
  }

  team2[10 - 1] = '\0';
  scoreTeam1 = new_sym_var(sizeof(int) * 8);
  scoreTeam2 = new_sym_var(sizeof(int) * 8);
  h_name = gameHash(name, 1000);
  h_team1 = teamHash(team1, 1000);
  h_team2 = teamHash(team2, 1000);
  if (gameHtNodeSelect(data->gamesHT[h_name], name))
  {
    printf("%d Jogo existente.\n", NL);
    return data;
  }
  else
  {
    
  }

  team1Node = teamHtNodeSelect(data->teamsHT[h_team1], team1);
  team2Node = teamHtNodeSelect(data->teamsHT[h_team2], team2);
  if ((team1Node == 0) || (team2Node == 0))
  {
    printf("%d Equipa inexistente.\n", NL);
    return data;
  }
  else
  {
    
  }

  linkG = gameLinkCreate(game_create(name, team1, team2, scoreTeam1, scoreTeam2));
  data->Gamesdll->head = gameLinkInsert(data->Gamesdll->head, linkG);
  data->gamesHT[h_name] = gameHtNodeInsert(data->gamesHT[h_name], data->Gamesdll->head);
  if (gameListOneElement(data->Gamesdll))
  {
    data->Gamesdll->last = data->Gamesdll->head;
  }
  else
  {
    
  }

  if (scoreTeam1 != scoreTeam2)
  {
    if (scoreTeam1 > scoreTeam2)
    {
      team1Node->link->team->games_won += 1;
    }
    else
    {
      team2Node->link->team->games_won += 1;
    }

  }
  else
  {
    
  }

  return data;
}

Data adicionaTeam(Data data)
{
  char newTeam[1024];
  int h_team;
  TeamLink linkT;
  NL++;
  for (int newTeam_index = 0; newTeam_index < 10; newTeam_index++)
  {
    newTeam[newTeam_index] = new_sym_var(sizeof(char) * 8);
  }

  newTeam[10 - 1] = '\0';
  h_team = teamHash(newTeam, 1000);
  if (teamHtNodeSelect(data->teamsHT[h_team], newTeam))
  {
    printf("%d Equipa existente.\n", NL);
    return data;
  }
  else
  {
    
  }

  linkT = teamLinkCreate(team_create(newTeam));
  data->Teamsdll->head = teamLinkInsert(data->Teamsdll->head, linkT);
  data->teamsHT[h_team] = teamHtNodeInsert(data->teamsHT[h_team], data->Teamsdll->head);
  if (teamListOneElement(data->Teamsdll))
  {
    data->Teamsdll->last = data->Teamsdll->head;
  }
  else
  {
    
  }

  return data;
}

void procuraJogo(Data data)
{
  char gameName[1024];
  int h_name;
  GameHT_node node;
  NL++;
  for (int gameName_index = 0; gameName_index < 10; gameName_index++)
  {
    gameName[gameName_index] = new_sym_var(sizeof(char) * 8);
  }

  gameName[10 - 1] = '\0';
  h_name = gameHash(gameName, 1000);
  if (node = gameHtNodeSelect(data->gamesHT[h_name], gameName))
  {
    printf("%d %s %s %s %d %d\n", NL, node->link->game->name, node->link->game->team1, node->link->game->team2, node->link->game->score1, node->link->game->score2);
  }
  else
  {
    printf("%d Jogo inexistente.\n", NL);
  }

}

void procuraTeam(Data data)
{
  char teamName[1024];
  int h_name;
  TeamHT_node node;
  NL++;
  for (int teamName_index = 0; teamName_index < 10; teamName_index++)
  {
    teamName[teamName_index] = new_sym_var(sizeof(char) * 8);
  }

  teamName[10 - 1] = '\0';
  h_name = gameHash(teamName, 1000);
  if (node = teamHtNodeSelect(data->teamsHT[h_name], teamName))
  {
    printf("%d %s %d\n", NL, node->link->team->name, node->link->team->games_won);
  }
  else
  {
    printf("%d Equipa inexistente.\n", NL);
  }

}

Data apagaJogo(Data data)
{
  char name[1024];
  int h_name;
  int h_team1;
  int h_team2;
  GameHT_node gameNode;
  TeamHT_node team1;
  TeamHT_node team2;
  GameLink linkG;
  NL++;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  h_name = gameHash(name, 1000);
  gameNode = gameHtNodeSelect(data->gamesHT[h_name], name);
  if (gameNode == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return data;
  }
  else
  {
    
  }

  linkG = gameNode->link;
  h_team1 = teamHash(gameNode->link->game->team1, 1000);
  h_team2 = teamHash(gameNode->link->game->team2, 1000);
  team1 = teamHtNodeSelect(data->teamsHT[h_team1], gameNode->link->game->team1);
  team2 = teamHtNodeSelect(data->teamsHT[h_team2], gameNode->link->game->team2);
  if (gameNode->link->game->score1 > gameNode->link->game->score2)
  {
    team1->link->team->games_won -= 1;
  }
  else
  {
    
  }

  if (gameNode->link->game->score1 < gameNode->link->game->score2)
  {
    team2->link->team->games_won -= 1;
  }
  else
  {
    
  }

  data->gamesHT[h_name] = gameHtNodeRemove(data->gamesHT[h_name], name);
  data->Gamesdll = gameListUpdate(data->Gamesdll, gameListIsHead(data->Gamesdll, linkG), gameListIsLast(data->Gamesdll, linkG));
  gameLinkRemove(linkG);
  return data;
}

Data alteraScore(Data data)
{
  char name[1024];
  int newScore1;
  int newScore2;
  int h_name;
  int h_team1;
  int h_team2;
  int oldScore1;
  int oldScore2;
  GameHT_node gameNode;
  TeamHT_node team1;
  TeamHT_node team2;
  NL++;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  newScore1 = new_sym_var(sizeof(int) * 8);
  newScore2 = new_sym_var(sizeof(int) * 8);
  h_name = gameHash(name, 1000);
  gameNode = gameHtNodeSelect(data->gamesHT[h_name], name);
  if (gameNode == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return data;
  }
  else
  {
    
  }

  h_team1 = teamHash(gameNode->link->game->team1, 1000);
  h_team2 = teamHash(gameNode->link->game->team2, 1000);
  team1 = teamHtNodeSelect(data->teamsHT[h_team1], gameNode->link->game->team1);
  team2 = teamHtNodeSelect(data->teamsHT[h_team2], gameNode->link->game->team2);
  oldScore1 = gameNode->link->game->score1;
  oldScore2 = gameNode->link->game->score2;
  if (findWinner(oldScore1, oldScore2) != findWinner(newScore1, newScore2))
  {
    if (findWinner(oldScore1, oldScore2) == 0)
    {
      if (newScore1 > newScore2)
      {
        team1->link->team->games_won += 1;
      }
      else
      {
        team2->link->team->games_won += 1;
      }

    }
    else
    {
      if (findWinner(newScore1, newScore2) == 0)
      {
        if (oldScore1 > oldScore2)
        {
          team1->link->team->games_won -= 1;
        }
        else
        {
          team2->link->team->games_won -= 1;
        }

      }
      else
      {
        if (findWinner(oldScore1, oldScore2) > findWinner(newScore1, newScore2))
        {
          team1->link->team->games_won += 1;
          team2->link->team->games_won -= 1;
        }
        else
        {
          team2->link->team->games_won += 1;
          team1->link->team->games_won -= 1;
        }

      }

    }

  }
  else
  {
    
  }

  gameNode->link->game->score1 = newScore1;
  gameNode->link->game->score2 = newScore2;
  return data;
}

void printBest(Data data)
{
  int max;
  int n;
  int i;
  int j;
  int contador = 0;
  char comp[1024];
  char **v;
  TeamLink temp = data->Teamsdll->last;
  NL++;
  max = teamBest(data->Teamsdll);
  n = teamNumberBest(data->Teamsdll, max);
  if (n > 0)
  {
    v = malloc(n * (sizeof(char *)));
    for (i = 0; i < n; i++)
      v[i] = malloc(1024 * (sizeof(char)));

    for (; temp; temp = temp->previous)
    {
      if (temp->team->games_won == max)
      {
        strcpy(v[contador], temp->team->name);
        contador++;
      }
      else
      {
        
      }

    }

    for (i = 0; i < n; i++)
    {
      for (j = i + 1; j < n; j++)
      {
        if (strcmp(v[i], v[j]) > 0)
        {
          strcpy(comp, v[i]);
          strcpy(v[i], v[j]);
          strcpy(v[j], comp);
        }
        else
        {
          
        }

      }

    }

    printf("%d Melhores %d\n", NL, max);
    for (i = 0; i < n; i++)
      printf("%d * %s\n", NL, v[i]);

    for (i = 0; i < n; i++)
      free(v[i]);

    free(v);
  }
  else
  {
    
  }

}

void data_free(Data data)
{
  gameLinkDestroy(data->Gamesdll->head);
  gameListFree(data->Gamesdll);
  teamLinkDestroy(data->Teamsdll->head);
  teamListFree(data->Teamsdll);
  teamHtFree(data->teamsHT, 1000);
  gameHtFree(data->gamesHT, 1000);
  free(data);
}

int main()
{
  int comando;
  Data data = data_init();
  while ((comando = getchar()) != 'x')
  {
    switch (comando)
    {
      case 'a':
        data = adicionaJogo(data);
        break;

      case 'A':
        data = adicionaTeam(data);
        break;

      case 'l':
        NL++;
        gameListDisplayInfo(data->Gamesdll, NL);
        break;

      case 'p':
        procuraJogo(data);
        break;

      case 'P':
        procuraTeam(data);
        break;

      case 'r':
        data = apagaJogo(data);
        break;

      case 's':
        data = alteraScore(data);
        break;

      case 'g':
        printBest(data);
        break;

    }

  }

  data_free(data);
  return 0;
}

