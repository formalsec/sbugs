/*File generated by PreProcessor.py*/

#ifndef NAME
#define NAME 'n'        /* Selective character for a key be the name */

#include "hash_table.h"


node *create_node(void *data)
{
  node *n = malloc(sizeof(node));
  n->prev = 0;
  n->next = 0;
  n->data = data;
  return n;
}

void free_node(ht *h, node *n)
{
  h->free_data(n->data);
  free(n);
}

ht *create_ht(int size, destructor destroy_data, key_getter get_key_data)
{
  int i;
  ht *h = malloc(sizeof(ht));
  h->size = size;
  h->free_data = destroy_data;
  h->get_data_key = get_key_data;
  h->dll_head = 0;
  h->dll_tail = 0;
  h->row_heads = malloc((sizeof(node *)) * size);
  for (i = 0; i < size; ++i)
    h->row_heads[i] = 0;

  return h;
}

void free_ht(ht *h)
{
  node *current;
  node *next;
  for (current = h->dll_head; current; current = next)
  {
    next = current->next;
    free_node(h, current);
  }

  free(h->row_heads);
  free(h);
}

int hash(char *str, int m)
{
  int i;
  int dim;
  int len = strlen(str);
  int res = 0;
  dim = (len > 20) ? (20) : (len);
  for (i = 0; i < dim; i++)
    res += str[i] * (i + 1);

  return res % m;
}

void *find_in_ht(ht *h, char *key)
{
  node *n = h->row_heads[hash(key, h->size)];
  for (; n; n = n->ht_next)
    if (!strcmp(h->get_data_key(n->data), key))
  {
    return n->data;
  }
  else
  {
    
  }


  return 0;
}

void add_to_ht(ht *h, void *data)
{
  node *new_node;
  int row = hash(h->get_data_key(data), h->size);
  new_node = create_node(data);
  new_node->prev = h->dll_tail;
  new_node->ht_next = h->row_heads[row];
  h->row_heads[row] = new_node;
  if (h->dll_tail == 0)
  {
    h->dll_head = new_node;
  }
  else
  {
    h->dll_tail->next = new_node;
  }

  h->dll_tail = new_node;
}

void remove_in_ht(ht *h, char *key)
{
  int row = hash(key, h->size);
  node *n;
  node *prev;
  node *head = h->row_heads[row];
  for (prev = 0, n = head; n; prev = n, n = n->ht_next)
  {
    if (!strcmp(key, h->get_data_key(n->data)))
    {
      if (n == head)
      {
        h->row_heads[row] = n->ht_next;
      }
      else
      {
        prev->ht_next = n->ht_next;
      }

      if (!n->prev)
      {
        h->dll_head = n->next;
      }
      else
      {
        n->prev->next = n->next;
      }

      if (!n->next)
      {
        h->dll_tail = n->prev;
      }
      else
      {
        n->next->prev = n->prev;
      }

      free_node(h, n);
      return;
    }
    else
    {
      
    }

  }

}

void apply_all_in_ht(ht *h, void (*do_something)(void *))
{
  node *n;
  for (n = h->dll_head; n; n = n->next)
    do_something(n->data);

}

#endif