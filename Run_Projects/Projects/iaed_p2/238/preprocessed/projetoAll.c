/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdbool.h>


typedef struct game
{
  char *name;
  char *team1;
  char *team2;
  int score1;
  int score2;
} game;
typedef struct g_node
{
  game *pointer_game;
  struct g_node *next;
} g_node;
typedef struct team
{
  char *name;
  int wins;
} team;
typedef struct t_node
{
  team *pointer_team;
  struct t_node *next;
} t_node;
typedef struct game_name_slot
{
  char *name;
  struct game_name_slot *next;
  struct game_name_slot *previous;
} game_slot;
typedef struct team_name_slot
{
  team *pointer_team;
  struct team_name_slot *next;
} team_slot;
game *newGame(char *name, char *team1, char *team2, int score1, int score2);
team *newTeam(char *name);
g_node *insertGameNode(g_node *head, char *name, char *team1, char *team2, int score1, int score2);
t_node *insertTeamNode(t_node *head, char *name);
int hash(char *string, int size);
void addGame(g_node **games, t_node **teams, game_slot **game_storage_head, int NL);
void addWin(t_node **teams, char *name);
void subtractWin(t_node **teams, g_node *pointer_g_node);
void addTeam(t_node **teams, team_slot **team_storage_head, int NL);
void removeGame(g_node **games, t_node **teams, game_slot **game_storage_head, int NL);
void freeAll(g_node **games, t_node **teams, game_slot **game_storage_head, team_slot **team_storage_head);
void deleteGameFromHashTable(g_node **games, g_node *head, char *name, int key);
void deleteGameFromStorage(game_slot **game_storage_head, char *name);
void deleteTeamFromHashTable(t_node **teams, t_node *head, char *name, int key);
void deleteTeamFromStorage(team_slot **team_storage_head, team *pointer_team);
game_slot *findGameInStorage(game_slot *game_storage_head, char *name);
team_slot *findTeamInStorage(team_slot *team_storage_head, team *pointer_team);
team_slot *findPreviousTeamInStorage(team_slot *team_storage_head, team *pointer_team);
g_node *findPreviousGame(g_node *head, char *name);
t_node *findPreviousTeam(t_node *head, char *name);
void listGames(g_node **games, game_slot *game_storage_head, int NL);
g_node *findGame(g_node *head, char *name);
t_node *findTeam(t_node *head, char *name);
void lookupGame(g_node **games, int NL);
void lookupTeam(t_node **teams, int NL);
void addGameStorage(game_slot **game_storage_head, char *name);
void addTeamStorage(team_slot **team_storage_head, team *pointer_team);
void changeGameScore(g_node **games, t_node **teams, int NL);
void listWinners(team_slot *team_storage_head, int NL);
void WinsAndWinners(team_slot *team_storage_head, int *max_wins, int *number_winners);
int compare_string(const void *p1, const void *p2);
int main()
{
  g_node **games;
  t_node **teams;
  game_slot *game_storage_head = 0;
  team_slot *team_storage_head = 0;
  char c;
  int NL = 0;
  int i;
  games = malloc(1747 * (sizeof(g_node *)));
  for (i = 0; i < 1747; i++)
    games[i] = 0;

  teams = malloc(1009 * (sizeof(t_node *)));
  for (i = 0; i < 1009; i++)
    teams[i] = 0;

  while (1)
  {
    switch (c = getchar())
    {
      case 'a':
        addGame(games, teams, &game_storage_head, ++NL);
        break;

      case 'l':
        listGames(games, game_storage_head, ++NL);
        break;

      case 'p':
        lookupGame(games, ++NL);
        break;

      case 'r':
        removeGame(games, teams, &game_storage_head, ++NL);
        break;

      case 's':
        changeGameScore(games, teams, ++NL);
        break;

      case 'A':
        addTeam(teams, &team_storage_head, ++NL);
        break;

      case 'P':
        lookupTeam(teams, ++NL);
        break;

      case 'g':
        listWinners(team_storage_head, ++NL);
        break;

      case 'x':
        freeAll(games, teams, &game_storage_head, &team_storage_head);
        exit(0);
        break;

    }

  }

  return 1;
}

game *newGame(char *name, char *team1, char *team2, int score1, int score2)
{
  game *pointer_game = (game *) malloc(sizeof(struct game));
  pointer_game->name = (char *) malloc((strlen(name) + 1) * (sizeof(char)));
  strcpy(pointer_game->name, name);
  pointer_game->team1 = (char *) malloc((strlen(team1) + 1) * (sizeof(char)));
  strcpy(pointer_game->team1, team1);
  pointer_game->team2 = (char *) malloc((strlen(team2) + 1) * (sizeof(char)));
  strcpy(pointer_game->team2, team2);
  pointer_game->score1 = score1;
  pointer_game->score2 = score2;
  return pointer_game;
}

team *newTeam(char *name)
{
  team *pointer_team = (team *) malloc(sizeof(struct team));
  pointer_team->name = (char *) malloc((strlen(name) + 1) * (sizeof(char)));
  strcpy(pointer_team->name, name);
  pointer_team->wins = 0;
  return pointer_team;
}

g_node *insertGameNode(g_node *head, char *name, char *team1, char *team2, int score1, int score2)
{
  g_node *pointer_g_node;
  g_node *aux;
  g_node *new_head;
  pointer_g_node = malloc(sizeof(struct g_node));
  new_head = head;
  pointer_g_node->pointer_game = newGame(name, team1, team2, score1, score2);
  pointer_g_node->next = 0;
  if (head != 0)
  {
    for (aux = head; aux->next != 0; aux = aux->next)
      ;

    aux->next = pointer_g_node;
  }
  else
  {
    new_head = pointer_g_node;
  }

  return new_head;
}

t_node *insertTeamNode(t_node *head, char *name)
{
  t_node *pointer_t_node;
  t_node *aux;
  t_node *new_head;
  pointer_t_node = malloc(sizeof(struct t_node));
  new_head = head;
  pointer_t_node->pointer_team = newTeam(name);
  pointer_t_node->next = 0;
  if (head != 0)
  {
    for (aux = head; aux->next != 0; aux = aux->next)
      ;

    aux->next = pointer_t_node;
  }
  else
  {
    new_head = pointer_t_node;
  }

  return new_head;
}

int hash(char *string, int size)
{
  int h = 0;
  int a = 127;
  for (; (*string) != '\0'; string++)
    h = ((a * h) + (*string)) % size;

  return h;
}

void addGame(g_node **games, t_node **teams, game_slot **game_storage_head, int NL)
{
  g_node *g_head;
  t_node *t1_head;
  t_node *t2_head;
  char name[1024] = "";
  char team1[1024] = "";
  char team2[1024] = "";
  int score1;
  int score2;
  int key_game;
  int key_team1;
  int key_team2;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  for (int team1_index = 0; team1_index < 10; team1_index++)
  {
    team1[team1_index] = new_sym_var(sizeof(char) * 8);
  }

  team1[10 - 1] = '\0';
  for (int team2_index = 0; team2_index < 10; team2_index++)
  {
    team2[team2_index] = new_sym_var(sizeof(char) * 8);
  }

  team2[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  key_game = hash(name, 1747);
  g_head = games[key_game];
  if (findGame(g_head, name) != 0)
  {
    printf("%d Jogo existente.\n", NL);
    return;
  }
  else
  {
    
  }

  key_team1 = hash(team1, 1009);
  t1_head = teams[key_team1];
  key_team2 = hash(team2, 1009);
  t2_head = teams[key_team2];
  if ((findTeam(t1_head, team1) == 0) || (findTeam(t2_head, team2) == 0))
  {
    printf("%d Equipa inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  games[key_game] = insertGameNode(g_head, name, team1, team2, score1, score2);
  addGameStorage(game_storage_head, name);
  if (score1 > score2)
  {
    addWin(teams, team1);
  }
  else
  {
    
  }

  if (score2 > score1)
  {
    addWin(teams, team2);
  }
  else
  {
    
  }

}

void addTeam(t_node **teams, team_slot **team_storage_head, int NL)
{
  t_node *head;
  t_node *pointer_t_node;
  team *pointer_team;
  char name[1024] = "";
  int key;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  key = hash(name, 1009);
  head = teams[key];
  if (findTeam(head, name) != 0)
  {
    printf("%d Equipa existente.\n", NL);
    return;
  }
  else
  {
    
  }

  teams[key] = insertTeamNode(head, name);
  head = teams[key];
  pointer_t_node = findTeam(head, name);
  pointer_team = pointer_t_node->pointer_team;
  addTeamStorage(team_storage_head, pointer_team);
}

void removeGame(g_node **games, t_node **teams, game_slot **game_storage_head, int NL)
{
  g_node *g_head;
  g_node *pointer_g_node;
  char name[1024] = "";
  int key_game;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  key_game = hash(name, 1747);
  g_head = games[key_game];
  pointer_g_node = findGame(g_head, name);
  if (pointer_g_node == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  subtractWin(teams, pointer_g_node);
  deleteGameFromHashTable(games, g_head, name, key_game);
  deleteGameFromStorage(game_storage_head, name);
}

void addWin(t_node **teams, char *name)
{
  t_node *pointer_t_node;
  t_node *head;
  team *pointer_team;
  int key;
  key = hash(name, 1009);
  head = teams[key];
  pointer_t_node = findTeam(head, name);
  pointer_team = pointer_t_node->pointer_team;
  pointer_team->wins += 1;
}

void subtractWin(t_node **teams, g_node *pointer_g_node)
{
  t_node *t_head;
  t_node *pointer_t_node;
  team *pointer_team;
  char *team;
  int key_team;
  int score1;
  int score2;
  score1 = pointer_g_node->pointer_game->score1;
  score2 = pointer_g_node->pointer_game->score2;
  if ((score1 > score2) || (score2 > score1))
  {
    if (score1 > score2)
    {
      team = pointer_g_node->pointer_game->team1;
    }
    else
    {
      team = pointer_g_node->pointer_game->team2;
    }

    key_team = hash(team, 1009);
    t_head = teams[key_team];
    pointer_t_node = findTeam(t_head, team);
    pointer_team = pointer_t_node->pointer_team;
    pointer_team->wins -= 1;
  }
  else
  {
    
  }

}

void freeAll(g_node **games, t_node **teams, game_slot **game_storage_head, team_slot **team_storage_head)
{
  g_node *g_head;
  t_node *t_head;
  game_slot *g_pointer_slot;
  team_slot *t_pointer_slot;
  team *pointer_team;
  char *name;
  int key;
  while ((*game_storage_head) != 0)
  {
    g_pointer_slot = *game_storage_head;
    name = g_pointer_slot->name;
    key = hash(name, 1747);
    g_head = games[key];
    deleteGameFromHashTable(games, g_head, name, key);
    deleteGameFromStorage(game_storage_head, name);
  }

  while ((*team_storage_head) != 0)
  {
    t_pointer_slot = *team_storage_head;
    pointer_team = t_pointer_slot->pointer_team;
    name = pointer_team->name;
    key = hash(name, 1009);
    t_head = teams[key];
    deleteTeamFromStorage(team_storage_head, pointer_team);
    deleteTeamFromHashTable(teams, t_head, name, key);
  }

}

void deleteGameFromHashTable(g_node **games, g_node *head, char *name, int key)
{
  g_node *pointer_g_node;
  g_node *previous;
  game *pointer_game;
  char *team1;
  char *team2;
  char *name_in_hashtable;
  previous = findPreviousGame(head, name);
  if (previous != 0)
  {
    pointer_g_node = previous->next;
    previous->next = pointer_g_node->next;
  }
  else
  {
    pointer_g_node = head;
    games[key] = pointer_g_node->next;
  }

  pointer_game = pointer_g_node->pointer_game;
  team1 = pointer_game->team1;
  team2 = pointer_game->team2;
  name_in_hashtable = pointer_game->name;
  free(team1);
  free(team2);
  free(name_in_hashtable);
  free(pointer_game);
  free(pointer_g_node);
}

void deleteGameFromStorage(game_slot **game_storage_head, char *name)
{
  game_slot *pointer_slot;
  char *name_in_storage;
  pointer_slot = findGameInStorage(*game_storage_head, name);
  if ((*game_storage_head) == pointer_slot)
  {
    *game_storage_head = pointer_slot->next;
  }
  else
  {
    
  }

  if (pointer_slot->next != 0)
  {
    pointer_slot->next->previous = pointer_slot->previous;
  }
  else
  {
    
  }

  if (pointer_slot->previous != 0)
  {
    pointer_slot->previous->next = pointer_slot->next;
  }
  else
  {
    
  }

  name_in_storage = pointer_slot->name;
  free(name_in_storage);
  free(pointer_slot);
}

void deleteTeamFromHashTable(t_node **teams, t_node *head, char *name, int key)
{
  t_node *pointer_t_node;
  t_node *previous;
  team *pointer_team;
  char *name_in_hashtable;
  previous = findPreviousTeam(head, name);
  if (previous != 0)
  {
    pointer_t_node = previous->next;
    previous->next = pointer_t_node->next;
  }
  else
  {
    pointer_t_node = head;
    teams[key] = pointer_t_node->next;
  }

  pointer_team = pointer_t_node->pointer_team;
  name_in_hashtable = pointer_team->name;
  free(name_in_hashtable);
  free(pointer_team);
  free(pointer_t_node);
}

void deleteTeamFromStorage(team_slot **team_storage_head, team *pointer_team)
{
  team_slot *pointer_slot;
  team_slot *previous_pointer_slot;
  previous_pointer_slot = findPreviousTeamInStorage(*team_storage_head, pointer_team);
  if (previous_pointer_slot != 0)
  {
    pointer_slot = previous_pointer_slot->next;
    previous_pointer_slot->next = pointer_slot->next;
  }
  else
  {
    pointer_slot = *team_storage_head;
    *team_storage_head = pointer_slot->next;
  }

  free(pointer_slot);
}

void lookupGame(g_node **games, int NL)
{
  g_node *head;
  g_node *pointer_g_node;
  game *pointer_game;
  char name[1024] = "";
  int key;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  key = hash(name, 1747);
  head = games[key];
  pointer_g_node = findGame(head, name);
  if (pointer_g_node == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  pointer_game = pointer_g_node->pointer_game;
  printf("%d %s %s %s %d %d\n", NL, pointer_game->name, pointer_game->team1, pointer_game->team2, pointer_game->score1, pointer_game->score2);
}

void lookupTeam(t_node **teams, int NL)
{
  t_node *head;
  t_node *pointer_t_node;
  team *pointer_team;
  char name[1024] = "";
  int key;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  key = hash(name, 1009);
  head = teams[key];
  pointer_t_node = findTeam(head, name);
  if (pointer_t_node == 0)
  {
    printf("%d Equipa inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  pointer_team = pointer_t_node->pointer_team;
  printf("%d %s %d\n", NL, pointer_team->name, pointer_team->wins);
}

void addGameStorage(game_slot **game_storage_head, char *name)
{
  game_slot *pointer_slot;
  pointer_slot = malloc(sizeof(game_slot));
  pointer_slot->name = (char *) malloc((strlen(name) + 1) * (sizeof(char)));
  strcpy(pointer_slot->name, name);
  pointer_slot->next = *game_storage_head;
  pointer_slot->previous = 0;
  if ((*game_storage_head) != 0)
  {
    (*game_storage_head)->previous = pointer_slot;
  }
  else
  {
    
  }

  *game_storage_head = pointer_slot;
}

void addTeamStorage(team_slot **team_storage_head, team *pointer_team)
{
  team_slot *pointer_slot;
  pointer_slot = malloc(sizeof(team_slot));
  pointer_slot->pointer_team = pointer_team;
  if ((*team_storage_head) == 0)
  {
    pointer_slot->next = 0;
  }
  else
  {
    pointer_slot->next = *team_storage_head;
  }

  *team_storage_head = pointer_slot;
}

void changeGameScore(g_node **games, t_node **teams, int NL)
{
  g_node *g_head;
  g_node *pointer_g_node;
  t_node *t_head;
  t_node *pointer_t_node1;
  t_node *pointer_t_node2;
  game *pointer_game;
  team *pointer_team1;
  team *pointer_team2;
  char name[1024] = "";
  char *team1;
  char *team2;
  int key;
  int score1;
  int score2;
  int previous_score1;
  int previous_score2;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  key = hash(name, 1747);
  g_head = games[key];
  pointer_g_node = findGame(g_head, name);
  if (pointer_g_node == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  pointer_game = pointer_g_node->pointer_game;
  team1 = pointer_game->team1;
  team2 = pointer_game->team2;
  previous_score1 = pointer_game->score1;
  previous_score2 = pointer_game->score2;
  key = hash(team1, 1009);
  t_head = teams[key];
  pointer_t_node1 = findTeam(t_head, team1);
  pointer_team1 = pointer_t_node1->pointer_team;
  key = hash(team2, 1009);
  t_head = teams[key];
  pointer_t_node2 = findTeam(t_head, team2);
  pointer_team2 = pointer_t_node2->pointer_team;
  if ((previous_score1 <= previous_score2) && (score1 > score2))
  {
    pointer_team1->wins += 1;
  }
  else
  {
    
  }

  if ((previous_score1 > previous_score2) && (score1 <= score2))
  {
    pointer_team1->wins -= 1;
  }
  else
  {
    
  }

  if ((previous_score2 <= previous_score1) && (score2 > score1))
  {
    pointer_team2->wins += 1;
  }
  else
  {
    
  }

  if ((previous_score2 > previous_score1) && (score2 <= score1))
  {
    pointer_team2->wins -= 1;
  }
  else
  {
    
  }

  pointer_game->score1 = score1;
  pointer_game->score2 = score2;
}

void listWinners(team_slot *team_storage_head, int NL)
{
  team *pointer_team;
  team_slot *pointer_slot;
  int max_wins = -1;
  int number_winners = 0;
  int i = 0;
  char **array;
  if (team_storage_head != 0)
  {
    WinsAndWinners(team_storage_head, &max_wins, &number_winners);
    array = malloc(number_winners * (sizeof(char *)));
    printf("%d Melhores %d\n", NL, max_wins);
    for (pointer_slot = team_storage_head; pointer_slot != 0; pointer_slot = pointer_slot->next)
    {
      pointer_team = pointer_slot->pointer_team;
      if (pointer_team->wins == max_wins)
      {
        array[i] = pointer_team->name;
        ++i;
      }
      else
      {
        
      }

    }

    qsort(array, number_winners, sizeof(char *), compare_string);
    for (i = 0; i < number_winners; ++i)
      printf("%d * %s\n", NL, array[i]);

    free(array);
  }
  else
  {
    
  }

}

void WinsAndWinners(team_slot *team_storage_head, int *max_wins, int *number_winners)
{
  team *pointer_team;
  team_slot *pointer_slot;
  for (pointer_slot = team_storage_head; pointer_slot != 0; pointer_slot = pointer_slot->next)
  {
    pointer_team = pointer_slot->pointer_team;
    if (pointer_team->wins == (*max_wins))
    {
      *number_winners = (*number_winners) + 1;
    }
    else
    {
      
    }

    if (pointer_team->wins > (*max_wins))
    {
      *max_wins = pointer_team->wins;
      *number_winners = 1;
    }
    else
    {
      
    }

  }

}

int compare_string(const void *p1, const void *p2)
{
  return strcmp(*((char **) p1), *((char **) p2));
}

game_slot *findGameInStorage(game_slot *game_storage_head, char *name)
{
  game_slot *pointer_slot;
  for (pointer_slot = game_storage_head; pointer_slot != 0; pointer_slot = pointer_slot->next)
  {
    if (strcmp(pointer_slot->name, name) == 0)
    {
      return pointer_slot;
    }
    else
    {
      
    }

  }

  return 0;
}

team_slot *findTeamInStorage(team_slot *team_storage_head, team *pointer_team)
{
  team_slot *pointer_slot;
  for (pointer_slot = team_storage_head; pointer_slot != 0; pointer_slot = pointer_slot->next)
  {
    if (pointer_slot->pointer_team == pointer_team)
    {
      return pointer_slot;
    }
    else
    {
      
    }

  }

  return 0;
}

team_slot *findPreviousTeamInStorage(team_slot *team_storage_head, team *pointer_team)
{
  team_slot *pointer_slot;
  for (pointer_slot = team_storage_head; pointer_slot->next != 0; pointer_slot = pointer_slot->next)
  {
    if (pointer_slot->next->pointer_team == pointer_team)
    {
      return pointer_slot;
    }
    else
    {
      
    }

  }

  return 0;
}

g_node *findGame(g_node *head, char *name)
{
  g_node *pointer_g_node;
  game *pointer_game;
  for (pointer_g_node = head; pointer_g_node != 0; pointer_g_node = pointer_g_node->next)
  {
    pointer_game = pointer_g_node->pointer_game;
    if (strcmp(pointer_game->name, name) == 0)
    {
      return pointer_g_node;
    }
    else
    {
      
    }

  }

  return 0;
}

t_node *findTeam(t_node *head, char *name)
{
  t_node *pointer_t_node;
  team *pointer_team;
  for (pointer_t_node = head; pointer_t_node != 0; pointer_t_node = pointer_t_node->next)
  {
    pointer_team = pointer_t_node->pointer_team;
    if (strcmp(pointer_team->name, name) == 0)
    {
      return pointer_t_node;
    }
    else
    {
      
    }

  }

  return 0;
}

g_node *findPreviousGame(g_node *head, char *name)
{
  g_node *previous_pointer;
  for (previous_pointer = head; previous_pointer->next != 0; previous_pointer = previous_pointer->next)
  {
    if (strcmp(previous_pointer->next->pointer_game->name, name) == 0)
    {
      return previous_pointer;
    }
    else
    {
      
    }

  }

  return 0;
}

t_node *findPreviousTeam(t_node *head, char *name)
{
  t_node *previous_pointer;
  for (previous_pointer = head; previous_pointer->next != 0; previous_pointer = previous_pointer->next)
  {
    if (strcmp(previous_pointer->next->pointer_team->name, name) == 0)
    {
      return previous_pointer;
    }
    else
    {
      
    }

  }

  return 0;
}

void listGames(g_node **games, game_slot *game_storage_head, int NL)
{
  game_slot *pointer_slot;
  game_slot *aux_last;
  g_node *head;
  g_node *pointer_g_node;
  game *pointer_game;
  char *name;
  int key;
  if (game_storage_head != 0)
  {
    for (aux_last = game_storage_head; aux_last->next != 0; aux_last = aux_last->next)
      ;

    for (pointer_slot = aux_last; pointer_slot != 0; pointer_slot = pointer_slot->previous)
    {
      name = pointer_slot->name;
      key = hash(name, 1747);
      head = games[key];
      pointer_g_node = findGame(head, name);
      pointer_game = pointer_g_node->pointer_game;
      printf("%d %s %s %s %d %d\n", NL, pointer_game->name, pointer_game->team1, pointer_game->team2, pointer_game->score1, pointer_game->score2);
    }

  }
  else
  {
    
  }

}

