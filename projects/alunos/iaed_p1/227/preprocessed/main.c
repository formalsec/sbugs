#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include "produto.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>


typedef unsigned char bool;
int id = -1;
int ide = -1;
Produto lista_produtos[9999];
Produto lista_aux_produtos[9999];
Produto aux_produtos[9999];
Encomenda lista_encomenda[500];
void adiciona(char *frase)
{
  Produto produto;
  int i = 0;
  int dados[3];
  id++;
  lista_produtos[id].produto_id = id;
  memset(&produto, 0, sizeof(Produto));
  frase = strtok(frase, ":");
  if (strlen(frase) >= 63)
  {
    return;
  }
  else
  {
    
  }

  strcpy(lista_produtos[id].descricao, frase);
  while (i < 3)
  {
    dados[i++] = atoi(strtok(0, ":"));
  }

  i = 0;
  lista_produtos[id].preco = dados[0];
  lista_produtos[id].peso = dados[1];
  lista_produtos[id].stock = dados[2];
  printf("Novo produto %d.\n", lista_produtos[id].produto_id);
}

void adiciona_stock(char *frase)
{
  int i = 0;
  int m = 0;
  int j;
  int n = -1;
  frase = strtok(frase, ":");
  m = atoi(frase);
  j = atoi(strtok(0, ":"));
  for (i = 0; i <= id; i++)
  {
    if (lista_produtos[i].produto_id == m)
    {
      lista_produtos[i].stock += j;
      n = j;
      break;
    }
    else
    {
      
    }

  }

  if (n == (-1))
  {
    printf("Impossivel adicionar produto %d ao stock. Produto inexistente.\n", m);
  }
  else
  {
    
  }

}

void cria_encomenda()
{
  Encomenda encomenda;
  ide++;
  encomenda.encomenda_id = ide;
  encomenda.encomenda_peso = 0;
  lista_encomenda[ide] = encomenda;
  printf("Nova encomenda %d.\n", ide);
}

int auxilia_encomenda(int m)
{
  int n;
  int j = 0;
  for (n = 0; n <= ide; n++)
  {
    if (lista_encomenda[n].encomenda_id == m)
    {
      j++;
      break;
    }
    else
    {
      
    }

  }

  if (j == 1)
  {
    return 1;
  }
  else
  {
    return 0;
  }

}

int auxilia_produto(int m, int i)
{
  int n;
  int j = 0;
  for (n = 0; n <= id; n++)
  {
    if (lista_encomenda[m].encomenda_produto[n].produto_id == i)
    {
      j = n;
    }
    else
    {
      
    }

  }

  if (j >= 0)
  {
    return 1;
  }
  else
  {
    return 0;
  }

}

int existe_produto(int m)
{
  int n = 0;
  for (n = 0; n <= id; n++)
  {
    if (lista_produtos[n].produto_id == m)
    {
      return 1;
    }
    else
    {
      
    }

  }

  return 0;
}

int auxilia_stock(int n, int m)
{
  int j = 0;
  if ((lista_produtos[n].stock >= m) && (lista_produtos[n].stock > 0))
  {
    j = lista_produtos[n].stock;
  }
  else
  {
    
  }

  if (j > 0)
  {
    return j;
  }
  else
  {
    return 0;
  }

}

void adiciona_produto(char *frase)
{
  int m = 0;
  int i = 0;
  int dados[2];
  frase = strtok(frase, ":");
  m = atoi(frase);
  while (i < 2)
  {
    dados[i++] = atoi(strtok(0, ":"));
  }

  i = 0;
  if (auxilia_encomenda(m))
  {
    if (existe_produto(dados[0]))
    {
      if (auxilia_stock(dados[0], dados[1]))
      {
        if ((lista_encomenda[m].encomenda_peso + (lista_produtos[dados[0]].peso * dados[1])) <= 200)
        {
          if (auxilia_produto(m, dados[0]))
          {
            lista_produtos[dados[0]].stock -= dados[1];
            lista_encomenda[m].encomenda_produto[dados[0]].stock += dados[1];
            lista_encomenda[m].encomenda_peso += lista_produtos[dados[0]].peso * dados[1];
            lista_encomenda[m].encomenda_produto[dados[0]].preco += lista_produtos[dados[0]].preco * dados[1];
          }
          else
          {
            memcpy(&lista_encomenda[m].encomenda_produto[dados[0]], &lista_produtos[dados[0]], sizeof(Produto));
            lista_encomenda[m].encomenda_produto[dados[0]].produto_id = dados[0];
            lista_encomenda[m].encomenda_produto[dados[0]].preco = lista_produtos[dados[0]].preco * dados[1];
            lista_produtos[dados[0]].stock -= dados[1];
            lista_encomenda[m].encomenda_produto[dados[0]].stock += dados[1];
            lista_encomenda[m].encomenda_peso += lista_produtos[dados[0]].peso * dados[1];
          }

        }
        else
        {
          printf("Impossivel adicionar produto %d a encomenda %d. Peso da encomenda excede o maximo de 200.\n", dados[0], m);
        }

      }
      else
      {
        printf("Impossivel adicionar produto %d a encomenda %d. Quantidade em stock insuficiente.\n", dados[0], m);
      }

    }
    else
    {
      printf("Impossivel adicionar produto %d a encomenda %d. Produto inexistente.\n", dados[0], m);
    }

  }
  else
  {
    printf("Impossivel adicionar produto %d a encomenda %d. Encomenda inexistente.\n", dados[0], m);
  }

}

int auxilia_produto_stock(int m)
{
  int n;
  int j = -1;
  for (n = 0; n <= id; n++)
  {
    if (lista_produtos[n].produto_id == m)
    {
      j = n;
      break;
    }
    else
    {
      
    }

  }

  return j + 1;
}

void remove_stock(char *frase)
{
  int m;
  int j = 0;
  int p = 0;
  frase = strtok(frase, ":");
  m = atoi(frase);
  j = atoi(strtok(0, ":"));
  if (auxilia_produto_stock(m))
  {
    p = auxilia_produto_stock(m) - 1;
    if (lista_produtos[p].stock >= j)
    {
      lista_produtos[p].stock = lista_produtos[p].stock - j;
    }
    else
    {
      printf("Impossivel remover %d unidades do produto %d do stock. Quantidade insuficiente.\n", j, m);
    }

  }
  else
  {
    printf("Impossivel remover stock do produto %d. Produto inexistente.\n", m);
  }

}

void remove_encomenda(char *frase)
{
  int m;
  int j;
  frase = strtok(frase, ":");
  m = atoi(frase);
  j = atoi(strtok(0, ":"));
  if (auxilia_encomenda(m))
  {
    if (existe_produto(j))
    {
      if (auxilia_produto(m, j))
      {
        lista_encomenda[m].encomenda_produto[j].peso = 0;
        lista_encomenda[m].encomenda_produto[j].preco = 0;
        lista_encomenda[m].encomenda_produto[j].stock = 0;
        lista_encomenda[m].encomenda_peso -= lista_encomenda[m].encomenda_produto[j].peso * lista_encomenda[m].encomenda_produto[j].stock;
      }
      else
      {
        
      }

    }
    else
    {
      printf("Impossivel remover produto %d a encomenda %d. Produto inexistente.\n", j, m);
    }

  }
  else
  {
    printf("Impossivel remover produto %d a encomenda %d. Encomenda inexistente.\n", j, m);
  }

}

void calcula_custo(char *frase)
{
  int m;
  int n = 0;
  int custo = 0;
  frase = strtok(frase, ":");
  m = atoi(frase);
  if (auxilia_encomenda(m))
  {
    for (n = 0; n <= id; n++)
    {
      if (auxilia_produto(m, n))
      {
        custo += lista_encomenda[m].encomenda_produto[n].preco;
      }
      else
      {
        
      }

    }

    printf("Custo da encomenda %d %d.\n", m, custo);
  }
  else
  {
    printf("Impossivel calcular custo da encomenda %d. Encomenda inexistente.\n", m);
  }

}

void altera_preco(char *frase)
{
  int m;
  int j;
  int n = 0;
  frase = strtok(frase, ":");
  m = atoi(frase);
  j = atoi(strtok(0, ":"));
  if (existe_produto(m))
  {
    lista_produtos[m].preco = j;
    for (n = 0; n <= ide; n++)
    {
      if (lista_encomenda[n].encomenda_produto[m].produto_id >= 0)
      {
        lista_encomenda[n].encomenda_produto[m].preco = j;
      }
      else
      {
        
      }

    }

  }
  else
  {
    printf("Impossivel alterar preco do produto %d. Produto inexistente.\n", m);
  }

}

void lista_descricao(char *frase)
{
  int m;
  int j = 0;
  frase = strtok(frase, ":");
  m = atoi(frase);
  j = atoi(strtok(0, ":"));
  if (auxilia_encomenda(m))
  {
    if (existe_produto(j))
    {
      if (auxilia_produto(m, j))
      {
        printf("%s %d\n", lista_produtos[j].descricao, lista_encomenda[m].encomenda_produto[j].stock);
      }
      else
      {
        
      }

    }
    else
    {
      printf("Impossivel listar produto %d. Produto inexistente.\n", j);
    }

  }
  else
  {
    printf("Impossivel listar encomenda %d. Encomenda inexistente.\n", m);
  }

}

void lista_ocorrencia(char *frase)
{
  int m;
  int j;
  int l;
  int counter = 0;
  frase = strtok(frase, ":");
  m = atoi(frase);
  if (existe_produto(m))
  {
    for (j = 0; j <= ide; j++)
    {
      if ((lista_encomenda[j].encomenda_produto[m].stock > 0) && (lista_encomenda[j].encomenda_produto[m].stock > counter))
      {
        counter += lista_encomenda[j].encomenda_produto[m].stock;
        l = j;
      }
      else
      {
        
      }

    }

    if (counter == 0)
    {
      return;
    }
    else
    {
      printf("Maximo produto %d %d %d.\n", m, l, counter);
    }

  }
  else
  {
    printf("Impossivel listar maximo do produto %d. Produto inexistente.\n", m);
  }

}

int main()
{
  bool loop = 1;
  char command;
  char input[256];
  while (loop)
  {
    fgets(input, 256, stdin);
    command = input[0];
    switch (command)
    {
      case 'a':
        adiciona(input + 2);
        break;

      case 'q':
        adiciona_stock(input + 2);
        break;

      case 'N':
        cria_encomenda(input);
        break;

      case 'A':
        adiciona_produto(input + 2);
        break;

      case 'r':
        remove_stock(input + 2);
        break;

      case 'R':
        remove_encomenda(input + 2);
        break;

      case 'C':
        calcula_custo(input + 2);
        break;

      case 'p':
        altera_preco(input + 2);
        break;

      case 'E':
        lista_descricao(input + 2);
        break;

      case 'm':
        lista_ocorrencia(input + 2);
        break;

      case 'x':
        return 0;

    }

  }

  return 0;
}

