#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>


typedef struct produto
{
  int id;
  char descricao[64];
  int preco;
  int peso;
  int quantidade;
} produto;
typedef struct encomenda
{
  int id;
  produto produtos[200];
  int tamanho;
  int peso;
} encomenda;
int i;
int idp;
int ide;
int haEncomendas;
int haProdutos;
int tamanhoProdutosAOrdenar_L;
produto sistema[10000];
encomenda encomendas[500];
produto ProdutosAOrdenar_l[10000];
produto ProdutosAOrdenar_L[200];
void analisarComando(char comando[]);
void funcao_a(char comando[]);
void funcao_q(char comando[]);
void funcao_N();
void funcao_A(char comando[]);
void funcao_r(char comando[]);
void funcao_R(char comando[]);
void funcao_C(char comando[]);
void funcao_p(char comando[]);
void funcao_E(char comando[]);
void funcao_m(char comando[]);
void funcao_l();
void funcao_L(char comando[]);
int obtemNumero(char comando[]);
int produtoEmEncomenda(int idE, int idP);
int produtoEmEncomendas(int idP);
int encomendaExiste(int idE);
int produtoExiste(int idP);
int testaStock(int idP, int qtd);
int testaPeso(int idE, int idP, int qtd);
void alteraPrecoProdutoNasEncomendas(int idP, int novoPreco);
int obtemPosProduto(int nEncomenda, int idP);
int encomendaComMaisProduto(int idP);
void copiaString(char s1[], char s2[]);
void ordenaProdutos_l(int esquerda, int direita);
int particaoProdutos_l(int esquerda, int direita);
int menor_l(produto p1, produto p2);
void troca_l(int id1, int id2);
void ordenaProdutos_L(int esquerda, int direita);
int particaoProdutos_L(int esquerda, int direita);
int menor_L(produto p1, produto p2);
void troca_L(int id1, int id2);
void lower(char string[]);
int main()
{
  char comando[100];
  int c;
  int j;
  while (1)
  {
    c = getchar();
    j = 0;
    while ((c != '\n') && (c != EOF))
    {
      comando[j] = c;
      c = getchar();
      j++;
    }

    comando[j] = '\0';
    if (comando[0] == 'x')
    {
      return 0;
    }
    else
    {
      analisarComando(comando);
    }

  }

  return 0;
}

void analisarComando(char comando[])
{
  i = 0;
  switch (comando[0])
  {
    case 'a':
      funcao_a(comando);
      break;

    case 'q':
      funcao_q(comando);
      break;

    case 'N':
      funcao_N(comando);
      break;

    case 'A':
      funcao_A(comando);
      break;

    case 'r':
      funcao_r(comando);
      break;

    case 'R':
      funcao_R(comando);
      break;

    case 'C':
      funcao_C(comando);
      break;

    case 'p':
      funcao_p(comando);
      break;

    case 'E':
      funcao_E(comando);
      break;

    case 'm':
      funcao_m(comando);
      break;

    case 'l':
      funcao_l(comando);
      break;

    case 'L':
      funcao_L(comando);
      break;

    default:
      break;

  }

}

void funcao_a(char comando[])
{
  produto novoProduto;
  char descricao[64];
  i = 2;
  while (comando[i] != ':')
  {
    descricao[i - 2] = comando[i];
    i++;
  }

  descricao[i - 2] = '\0';
  if (haProdutos)
  {
    idp++;
  }
  else
  {
    
  }

  novoProduto.id = idp;
  copiaString(novoProduto.descricao, descricao);
  novoProduto.preco = obtemNumero(comando);
  novoProduto.peso = obtemNumero(comando);
  novoProduto.quantidade = obtemNumero(comando);
  sistema[idp] = novoProduto;
  haProdutos = 1;
  printf("Novo produto %d.\n", idp);
}

void funcao_q(char comando[])
{
  int idP = obtemNumero(comando);
  int qtd = obtemNumero(comando);
  if (produtoExiste(idP) && haProdutos)
  {
    sistema[idP].quantidade += qtd;
  }
  else
  {
    printf("Impossivel adicionar produto %d ao stock. Produto inexistente.\n", idP);
  }

}

void funcao_N()
{
  encomenda novaEncomenda;
  if (haEncomendas)
  {
    ide++;
  }
  else
  {
    
  }

  novaEncomenda.id = ide;
  novaEncomenda.peso = 0;
  novaEncomenda.tamanho = 0;
  encomendas[ide] = novaEncomenda;
  haEncomendas = 1;
  printf("Nova encomenda %d.\n", ide);
}

void funcao_A(char comando[])
{
  int tamanho;
  int posProd;
  produto novoProduto;
  int idE = obtemNumero(comando);
  int idP = obtemNumero(comando);
  int qtd = obtemNumero(comando);
  if (encomendaExiste(idE) && haEncomendas)
  {
    if (produtoExiste(idP) && haProdutos)
    {
      tamanho = encomendas[idE].tamanho;
      if (testaStock(idP, qtd))
      {
        if (testaPeso(idE, idP, qtd))
        {
          if (produtoEmEncomenda(idE, idP))
          {
            posProd = obtemPosProduto(idE, idP);
            encomendas[idE].produtos[posProd].quantidade += qtd;
          }
          else
          {
            novoProduto.id = idP;
            copiaString(novoProduto.descricao, sistema[idP].descricao);
            novoProduto.preco = sistema[idP].preco;
            novoProduto.peso = sistema[idP].peso;
            novoProduto.quantidade = qtd;
            encomendas[idE].produtos[tamanho] = novoProduto;
            encomendas[idE].tamanho += 1;
          }

          sistema[idP].quantidade -= qtd;
          encomendas[idE].peso += qtd * sistema[idP].peso;
        }
        else
        {
          printf("Impossivel adicionar produto %d a encomenda %d. Peso da encomenda excede o maximo de 200.\n", idP, idE);
        }

      }
      else
      {
        printf("Impossivel adicionar produto %d a encomenda %d. Quantidade em stock insuficiente.\n", idP, idE);
      }

    }
    else
    {
      printf("Impossivel adicionar produto %d a encomenda %d. Produto inexistente.\n", idP, idE);
    }

  }
  else
  {
    printf("Impossivel adicionar produto %d a encomenda %d. Encomenda inexistente.\n", idP, idE);
  }

}

void funcao_r(char comando[])
{
  int idP = obtemNumero(comando);
  int qtd = obtemNumero(comando);
  if (produtoExiste(idP) && haProdutos)
  {
    if (testaStock(idP, qtd))
    {
      sistema[idP].quantidade -= qtd;
    }
    else
    {
      printf("Impossivel remover %d unidades do produto %d do stock. Quantidade insuficiente.\n", qtd, idP);
    }

  }
  else
  {
    printf("Impossivel remover stock do produto %d. Produto inexistente.\n", idP);
  }

}

void funcao_R(char comando[])
{
  int idE = obtemNumero(comando);
  int idP = obtemNumero(comando);
  int qtd;
  int posProd;
  if (encomendaExiste(idE) && haEncomendas)
  {
    if (produtoExiste(idP) && haProdutos)
    {
      if (produtoEmEncomenda(idE, idP))
      {
        posProd = obtemPosProduto(idE, idP);
        qtd = encomendas[idE].produtos[posProd].quantidade;
        encomendas[idE].produtos[posProd].id = -1;
        encomendas[idE].produtos[posProd].quantidade = 0;
        encomendas[idE].peso -= sistema[idP].peso * qtd;
        sistema[idP].quantidade += qtd;
      }
      else
      {
        return;
      }

    }
    else
    {
      printf("Impossivel remover produto %d a encomenda %d. Produto inexistente.\n", idP, idE);
    }

  }
  else
  {
    printf("Impossivel remover produto %d a encomenda %d. Encomenda inexistente.\n", idP, idE);
  }

}

void funcao_C(char comando[])
{
  int idE = obtemNumero(comando);
  int j;
  int tamanho;
  int custo = 0;
  if (encomendaExiste(idE) && haEncomendas)
  {
    tamanho = encomendas[idE].tamanho;
    for (j = 0; j < tamanho; j++)
    {
      if (encomendas[idE].produtos[j].id > (-1))
      {
        custo += encomendas[idE].produtos[j].preco * encomendas[idE].produtos[j].quantidade;
      }
      else
      {
        
      }

    }

    printf("Custo da encomenda %d %d.\n", idE, custo);
  }
  else
  {
    printf("Impossivel calcular custo da encomenda %d. Encomenda inexistente.\n", idE);
  }

}

void funcao_p(char comando[])
{
  int idP = obtemNumero(comando);
  int novoPreco = obtemNumero(comando);
  if (produtoExiste(idP) && haProdutos)
  {
    sistema[idP].preco = novoPreco;
    alteraPrecoProdutoNasEncomendas(idP, novoPreco);
  }
  else
  {
    printf("Impossivel alterar preco do produto %d. Produto inexistente.\n", idP);
  }

}

void funcao_E(char comando[])
{
  int idE = obtemNumero(comando);
  int idP = obtemNumero(comando);
  int posProd;
  if (encomendaExiste(idE) && haEncomendas)
  {
    if (produtoExiste(idP) && haProdutos)
    {
      if (produtoEmEncomenda(idE, idP))
      {
        posProd = obtemPosProduto(idE, idP);
        printf("%s %d.\n", sistema[idP].descricao, encomendas[idE].produtos[posProd].quantidade);
      }
      else
      {
        printf("%s 0.\n", sistema[idP].descricao);
      }

    }
    else
    {
      printf("Impossivel listar produto %d. Produto inexistente.\n", idP);
      return;
    }

  }
  else
  {
    printf("Impossivel listar encomenda %d. Encomenda inexistente.\n", idE);
    return;
  }

}

void funcao_m(char comando[])
{
  int idP = obtemNumero(comando);
  int indiceResultado;
  int qtd;
  int posProd;
  if (haEncomendas)
  {
    if (produtoExiste(idP) && haProdutos)
    {
      if (produtoEmEncomendas(idP))
      {
        indiceResultado = encomendaComMaisProduto(idP);
        posProd = obtemPosProduto(indiceResultado, idP);
        qtd = encomendas[indiceResultado].produtos[posProd].quantidade;
        printf("Maximo produto %d %d %d.\n", idP, indiceResultado, qtd);
      }
      else
      {
        return;
      }

    }
    else
    {
      printf("Impossivel listar maximo do produto %d. Produto inexistente.\n", idP);
    }

  }
  else
  {
    return;
  }

}

void funcao_l()
{
  int j;
  if (haProdutos)
  {
    for (j = 0; j < (idp + 1); j++)
    {
      produto novoProduto;
      novoProduto.id = sistema[j].id;
      copiaString(novoProduto.descricao, sistema[j].descricao);
      novoProduto.preco = sistema[j].preco;
      novoProduto.quantidade = sistema[j].quantidade;
      ProdutosAOrdenar_l[j] = novoProduto;
    }

    ordenaProdutos_l(0, idp);
  }
  else
  {
    
  }

  printf("Produtos\n");
  if (haProdutos)
  {
    for (j = 0; j < (idp + 1); j++)
    {
      printf("* %s %d %d\n", ProdutosAOrdenar_l[j].descricao, ProdutosAOrdenar_l[j].preco, ProdutosAOrdenar_l[j].quantidade);
    }

  }
  else
  {
    
  }

}

void funcao_L(char comando[])
{
  int idE;
  int tamanho;
  int j;
  idE = obtemNumero(comando);
  if (encomendaExiste(idE) && haEncomendas)
  {
    tamanho = encomendas[idE].tamanho;
    if (tamanho > 0)
    {
      tamanhoProdutosAOrdenar_L = 0;
      for (j = 0; j < tamanho; j++)
      {
        produto novoProduto;
        novoProduto.id = encomendas[idE].produtos[j].id;
        copiaString(novoProduto.descricao, encomendas[idE].produtos[j].descricao);
        novoProduto.preco = encomendas[idE].produtos[j].preco;
        novoProduto.quantidade = encomendas[idE].produtos[j].quantidade;
        ProdutosAOrdenar_L[j] = novoProduto;
        tamanhoProdutosAOrdenar_L++;
      }

      ordenaProdutos_L(0, tamanhoProdutosAOrdenar_L - 1);
      printf("Encomenda %d\n", idE);
      for (j = 0; j < tamanhoProdutosAOrdenar_L; j++)
      {
        if (ProdutosAOrdenar_L[j].id > (-1))
        {
          printf("* %s %d %d\n", ProdutosAOrdenar_L[j].descricao, ProdutosAOrdenar_L[j].preco, ProdutosAOrdenar_L[j].quantidade);
        }
        else
        {
          
        }

      }

    }
    else
    {
      printf("Encomenda %d\n", idE);
    }

  }
  else
  {
    printf("Impossivel listar encomenda %d. Encomenda inexistente.\n", idE);
  }

}

int obtemNumero(char comando[])
{
  int j = 0;
  char arrayNumero[100];
  while ((comando[i] < '0') || (comando[i] > '9'))
  {
    i++;
  }

  while ((comando[i] >= '0') && (comando[i] <= '9'))
  {
    arrayNumero[j] = comando[i];
    i++;
    j++;
  }

  arrayNumero[j] = '\0';
  return atoi(arrayNumero);
}

int produtoEmEncomenda(int idE, int idP)
{
  int j;
  int tamanho = encomendas[idE].tamanho;
  for (j = 0; j < tamanho; j++)
  {
    if (encomendas[idE].produtos[j].id == idP)
    {
      return 1;
    }
    else
    {
      
    }

  }

  return 0;
}

int produtoEmEncomendas(int idP)
{
  int j = 0;
  for (j = 0; j < (ide + 1); j++)
  {
    if (produtoEmEncomenda(j, idP))
    {
      return 1;
    }
    else
    {
      
    }

  }

  return 0;
}

int encomendaExiste(int idE)
{
  return haEncomendas && (idE <= ide);
}

int produtoExiste(int idP)
{
  return haProdutos && (idP <= idp);
}

int testaStock(int idP, int qtd)
{
  return sistema[idP].quantidade >= qtd;
}

int testaPeso(int idE, int idP, int qtd)
{
  int pesoAdicionado = sistema[idP].peso * qtd;
  return (encomendas[idE].peso + pesoAdicionado) <= 200;
}

void alteraPrecoProdutoNasEncomendas(int idP, int novoPreco)
{
  int j;
  int k;
  for (j = 0; j < (ide + 1); j++)
  {
    for (k = 0; k < encomendas[j].tamanho; k++)
    {
      if (encomendas[j].produtos[k].id == idP)
      {
        encomendas[j].produtos[k].preco = novoPreco;
      }
      else
      {
        
      }

    }

  }

}

int obtemPosProduto(int idE, int idP)
{
  int tamanho = encomendas[idE].tamanho;
  int j;
  for (j = 0; j < tamanho; j++)
  {
    if (encomendas[idE].produtos[j].id == idP)
    {
      return j;
    }
    else
    {
      
    }

  }

  return 0;
}

int encomendaComMaisProduto(int idP)
{
  int max = -1;
  int j;
  int indiceResultado = 0;
  int posProduto;
  for (j = 0; j < (ide + 1); j++)
  {
    if (produtoEmEncomenda(j, idP))
    {
      posProduto = obtemPosProduto(j, idP);
    }
    else
    {
      continue;
    }

    if ((encomendas[j].produtos[posProduto].id > (-1)) && (encomendas[j].produtos[posProduto].quantidade > max))
    {
      max = encomendas[j].produtos[posProduto].quantidade;
      indiceResultado = j;
    }
    else
    {
      
    }

  }

  return indiceResultado;
}

void ordenaProdutos_l(int esquerda, int direita)
{
  int k;
  if (direita <= esquerda)
  {
    return;
  }
  else
  {
    
  }

  k = particaoProdutos_l(esquerda, direita);
  ordenaProdutos_l(esquerda, k - 1);
  ordenaProdutos_l(k + 1, direita);
}

int particaoProdutos_l(int esquerda, int direita)
{
  int k = esquerda - 1;
  int j = direita;
  produto pivot = ProdutosAOrdenar_l[direita];
  while (k < j)
  {
    while (menor_l(ProdutosAOrdenar_l[++k], pivot))
      ;

    while (menor_l(pivot, ProdutosAOrdenar_l[--j]))
    {
      if (j == esquerda)
      {
        break;
      }
      else
      {
        
      }

    }

    if (k < j)
    {
      troca_l(k, j);
    }
    else
    {
      
    }

  }

  troca_l(k, direita);
  return k;
}

int menor_l(produto p1, produto p2)
{
  if (p1.preco < p2.preco)
  {
    return 1;
  }
  else
  {
    if (p1.preco == p2.preco)
    {
      return p1.id < p2.id;
    }
    else
    {
      return 0;
    }

  }

}

void troca_l(int id1, int id2)
{
  int auxID1;
  char auxDesc1[64];
  int auxPreco1;
  int auxQuantidade1;
  auxID1 = ProdutosAOrdenar_l[id1].id;
  copiaString(auxDesc1, ProdutosAOrdenar_l[id1].descricao);
  auxPreco1 = ProdutosAOrdenar_l[id1].preco;
  auxQuantidade1 = ProdutosAOrdenar_l[id1].quantidade;
  ProdutosAOrdenar_l[id1].id = ProdutosAOrdenar_l[id2].id;
  copiaString(ProdutosAOrdenar_l[id1].descricao, ProdutosAOrdenar_l[id2].descricao);
  ProdutosAOrdenar_l[id1].preco = ProdutosAOrdenar_l[id2].preco;
  ProdutosAOrdenar_l[id1].quantidade = ProdutosAOrdenar_l[id2].quantidade;
  ProdutosAOrdenar_l[id2].id = auxID1;
  copiaString(ProdutosAOrdenar_l[id2].descricao, auxDesc1);
  ProdutosAOrdenar_l[id2].preco = auxPreco1;
  ProdutosAOrdenar_l[id2].quantidade = auxQuantidade1;
}

void ordenaProdutos_L(int esquerda, int direita)
{
  int k;
  if (direita <= esquerda)
  {
    return;
  }
  else
  {
    
  }

  k = particaoProdutos_L(esquerda, direita);
  ordenaProdutos_L(esquerda, k - 1);
  ordenaProdutos_L(k + 1, direita);
}

int particaoProdutos_L(int esquerda, int direita)
{
  int k = esquerda - 1;
  int j = direita;
  produto pivot = ProdutosAOrdenar_L[direita];
  while (k < j)
  {
    while (menor_L(ProdutosAOrdenar_L[++k], pivot))
      ;

    while (menor_L(pivot, ProdutosAOrdenar_L[--j]))
    {
      if (j == esquerda)
      {
        break;
      }
      else
      {
        
      }

    }

    if (k < j)
    {
      troca_L(k, j);
    }
    else
    {
      
    }

  }

  troca_L(k, direita);
  return k;
}

int menor_L(produto p1, produto p2)
{
  int j = 0;
  char desc1[64];
  char desc2[64];
  int len1;
  int len2;
  copiaString(desc1, p1.descricao);
  copiaString(desc2, p2.descricao);
  len1 = strlen(desc1);
  len2 = strlen(desc2);
  lower(desc1);
  lower(desc2);
  if (len1 == len2)
  {
    for (j = 0; j < len1; j++)
    {
      if (desc1[j] < desc2[j])
      {
        return 1;
      }
      else
      {
        if (desc1[j] > desc2[j])
        {
          return 0;
        }
        else
        {
          
        }

      }

    }

    return 0;
  }
  else
  {
    if (len1 < len2)
    {
      for (j = 0; j < len1; j++)
      {
        if (desc1[j] < desc2[j])
        {
          return 1;
        }
        else
        {
          if (desc1[j] > desc2[j])
          {
            return 0;
          }
          else
          {
            
          }

        }

      }

      return 1;
    }
    else
    {
      if (len1 > len2)
      {
        for (j = 0; j < len2; j++)
        {
          if (desc1[j] < desc2[j])
          {
            return 1;
          }
          else
          {
            if (desc1[j] > desc2[j])
            {
              return 0;
            }
            else
            {
              
            }

          }

        }

        return 0;
      }
      else
      {
        
      }

    }

  }

  return 0;
}

void troca_L(int pos1, int pos2)
{
  int auxID1;
  char auxDesc1[64];
  int auxPreco1;
  int auxPeso1;
  int auxQuantidade1;
  auxID1 = ProdutosAOrdenar_L[pos1].id;
  copiaString(auxDesc1, ProdutosAOrdenar_L[pos1].descricao);
  auxPreco1 = ProdutosAOrdenar_L[pos1].preco;
  auxPeso1 = ProdutosAOrdenar_L[pos1].peso;
  auxQuantidade1 = ProdutosAOrdenar_L[pos1].quantidade;
  ProdutosAOrdenar_L[pos1].id = ProdutosAOrdenar_L[pos2].id;
  copiaString(ProdutosAOrdenar_L[pos1].descricao, ProdutosAOrdenar_L[pos2].descricao);
  ProdutosAOrdenar_L[pos1].preco = ProdutosAOrdenar_L[pos2].preco;
  ProdutosAOrdenar_L[pos1].peso = ProdutosAOrdenar_L[pos2].peso;
  ProdutosAOrdenar_L[pos1].quantidade = ProdutosAOrdenar_L[pos2].quantidade;
  ProdutosAOrdenar_L[pos2].id = auxID1;
  copiaString(ProdutosAOrdenar_L[pos2].descricao, auxDesc1);
  ProdutosAOrdenar_L[pos2].preco = auxPreco1;
  ProdutosAOrdenar_L[pos2].peso = auxPeso1;
  ProdutosAOrdenar_L[pos2].quantidade = auxQuantidade1;
}

void lower(char string[])
{
  int j = 0;
  while (string[j] != '\0')
  {
    if ((string[j] >= '0') && (string[j] <= '9'))
    {
      j++;
      continue;
    }
    else
    {
      
    }

    if ((string[j] >= 'A') && (string[j] <= 'Z'))
    {
      string[j] += 'a' - 'A';
    }
    else
    {
      
    }

    j++;
  }

}

void copiaString(char s1[], char s2[])
{
  int j = 0;
  for (j = 0; s2[j] != '\0'; j++)
  {
    s1[j] = s2[j];
  }

  s1[j] = '\0';
}

