#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>


typedef struct team
{
  char team_name[1024];
  int wins;
} *pointer_team;
typedef struct node_team
{
  pointer_team t;
  struct node_team *next_team;
} *link_team;
link_team *heads_team;
typedef struct game
{
  char game_name[1024];
  char team1_name[1024];
  char team2_name[1024];
  char winner[1024];
  int score1;
  int score2;
} *pointer_game;
typedef struct node_game
{
  pointer_game g;
  struct node_game *next_game;
} *link_game;
link_game *heads_game;
int hash(char *v, int dim)
{
  int h;
  int a = 31415;
  int b = 27183;
  for (h = 0; (*v) != '\0'; v++, a = (a * b) % (dim - 1))
    h = ((a * h) + (*v)) % dim;

  return h;
}

void init_hash_teams(int dim)
{
  int index;
  heads_team = (link_team *) malloc(dim * (sizeof(link_team)));
  for (index = 0; index < dim; index++)
  {
    heads_team[index] = 0;
  }

}

void init_hash_games(int dim)
{
  int index;
  heads_game = (link_game *) malloc(dim * (sizeof(link_game)));
  for (index = 0; index < dim; index++)
  {
    heads_game[index] = 0;
  }

}

link_team insert_beggin_list_team(link_team head, char *name)
{
  link_team aux = (link_team) malloc(sizeof(struct node_team));
  aux->t = (pointer_team) malloc(sizeof(struct team));
  strcpy(aux->t->team_name, name);
  aux->t->wins = 0;
  aux->next_team = head;
  return aux;
}

link_team search_team(link_team head, char *name)
{
  link_team aux;
  for (aux = head; aux != 0; aux = aux->next_team)
  {
    if (strcmp(aux->t->team_name, name) == 0)
    {
      return aux;
    }
    else
    {
      
    }

  }

  return 0;
}

void add_team(int line, int dim)
{
  int index;
  char name[1024];
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  index = hash(name, dim);
  if (search_team(heads_team[index], name) == 0)
  {
    heads_team[index] = insert_beggin_list_team(heads_team[index], name);
  }
  else
  {
    printf("%d Equipa existente.\n", line);
  }

}

void look_for_team(int line, int dim)
{
  int index;
  char name[1024];
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  index = hash(name, dim);
  if (search_team(heads_team[index], name) != 0)
  {
    printf("%d %s %d\n", line, heads_team[index]->t->team_name, heads_team[index]->t->wins);
  }
  else
  {
    printf("%d Equipa inexistente.\n", line);
  }

}

link_game insert_beggin_list_game(link_game head, char *name_of_game, char *team1_name, char *team2_name, int goals1, int goals2, char *winner)
{
  link_game aux = (link_game) malloc(sizeof(struct node_game));
  aux->g = (pointer_game) malloc(sizeof(struct game));
  strcpy(aux->g->game_name, name_of_game);
  strcpy(aux->g->team1_name, team1_name);
  strcpy(aux->g->team2_name, team2_name);
  strcpy(aux->g->winner, winner);
  aux->g->score1 = goals1;
  aux->g->score2 = goals2;
  aux->next_game = head;
  return aux;
}

link_game search_game(link_game head, char *name)
{
  link_game aux;
  for (aux = head; aux != 0; aux = aux->next_game)
  {
    if (strcmp(aux->g->game_name, name) == 0)
    {
      return aux;
    }
    else
    {
      
    }

  }

  return 0;
}

link_game delete_game(link_game head, char *name)
{
  link_game aux;
  link_game prev;
  for (aux = head, prev = 0; aux != 0; prev = aux, aux = aux->next_game)
  {
    if (strcmp(aux->g->game_name, name) == 0)
    {
      if (aux == head)
      {
        head = aux->next_game;
      }
      else
      {
        prev->next_game = aux->next_game;
      }

      free(aux->next_game);
      free(aux);
      break;
    }
    else
    {
      
    }

  }

  return head;
}

void add_game(int line, int vector_position, int dim, int *games_index)
{
  int index_game;
  int index_team1;
  int index_team2;
  int score1;
  int score2;
  char game_name[1024];
  char team1_name[1024];
  char team2_name[1024];
  char tie[1024];
  for (int game_name_index = 0; game_name_index < 10; game_name_index++)
  {
    game_name[game_name_index] = new_sym_var(sizeof(char) * 8);
  }

  game_name[10 - 1] = '\0';
  for (int team1_name_index = 0; team1_name_index < 10; team1_name_index++)
  {
    team1_name[team1_name_index] = new_sym_var(sizeof(char) * 8);
  }

  team1_name[10 - 1] = '\0';
  for (int team2_name_index = 0; team2_name_index < 10; team2_name_index++)
  {
    team2_name[team2_name_index] = new_sym_var(sizeof(char) * 8);
  }

  team2_name[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  index_game = hash(game_name, dim);
  index_team1 = hash(team1_name, dim);
  index_team2 = hash(team2_name, dim);
  if (search_game(heads_game[index_game], game_name) == 0)
  {
    if ((search_team(heads_team[index_team1], team1_name) != 0) && (search_team(heads_team[index_team2], team2_name) != 0))
    {
      if (score1 > score2)
      {
        heads_game[index_game] = insert_beggin_list_game(heads_game[index_game], game_name, team1_name, team2_name, score1, score2, team1_name);
        heads_team[index_team1]->t->wins++;
      }
      else
      {
        if (score1 == score2)
        {
          strcpy(tie, "tie");
          heads_game[index_game] = insert_beggin_list_game(heads_game[index_game], game_name, team1_name, team2_name, score1, score2, tie);
        }
        else
        {
          heads_game[index_game] = insert_beggin_list_game(heads_game[index_game], game_name, team1_name, team2_name, score1, score2, team2_name);
          heads_team[index_team2]->t->wins++;
        }

      }

      games_index[vector_position] = index_game;
    }
    else
    {
      printf("%d Equipa inexistente.\n", line);
    }

  }
  else
  {
    printf("%d Jogo existente.\n", line);
  }

}

void look_for_game(int line, int dim)
{
  int index;
  char name[1024];
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  index = hash(name, dim);
  if (search_game(heads_game[index], name) != 0)
  {
    printf("%d %s %s %s %d %d\n", line, name, heads_game[index]->g->team1_name, heads_game[index]->g->team2_name, heads_game[index]->g->score1, heads_game[index]->g->score2);
  }
  else
  {
    printf("%d Jogo inexistente.\n", line);
  }

}

void change_vector_content(int index, int vector_counter, int *games_index)
{
  int i;
  for (i = 0; i <= vector_counter; i++)
  {
    if (games_index[i] == index)
    {
      games_index[i] = -1;
      break;
    }
    else
    {
      
    }

  }

}

void remove_game(int line, int vector_counter, int dim, int *games_index)
{
  int index;
  int index_team1;
  int index_team2;
  char game_name[1024];
  for (int game_name_index = 0; game_name_index < 10; game_name_index++)
  {
    game_name[game_name_index] = new_sym_var(sizeof(char) * 8);
  }

  game_name[10 - 1] = '\0';
  index = hash(game_name, dim);
  if (search_game(heads_game[index], game_name) != 0)
  {
    if (strcmp(heads_game[index]->g->winner, heads_game[index]->g->team1_name) == 0)
    {
      index_team1 = hash(heads_game[index]->g->team1_name, dim);
      heads_team[index_team1]->t->wins--;
    }
    else
    {
      if (strcmp(heads_game[index]->g->winner, heads_game[index]->g->team2_name) == 0)
      {
        index_team2 = hash(heads_game[index]->g->team2_name, dim);
        heads_team[index_team2]->t->wins--;
      }
      else
      {
        
      }

    }

    delete_game(heads_game[index], game_name);
    change_vector_content(index, vector_counter, games_index);
  }
  else
  {
    printf("%d Jogo inexistente.\n", line);
  }

}

void change_score(int line, int dim)
{
  int index;
  int goals1;
  int goals2;
  int index_winner;
  int index_loser;
  int index_old_winner;
  char game_name[1024];
  for (int game_name_index = 0; game_name_index < 10; game_name_index++)
  {
    game_name[game_name_index] = new_sym_var(sizeof(char) * 8);
  }

  game_name[10 - 1] = '\0';
  goals1 = new_sym_var(sizeof(int) * 8);
  goals2 = new_sym_var(sizeof(int) * 8);
  index = hash(game_name, dim);
  if (search_game(heads_game[index], game_name) != 0)
  {
    heads_game[index]->g->score1 = goals1;
    heads_game[index]->g->score2 = goals2;
    if (goals1 > goals2)
    {
      if ((strcmp(heads_game[index]->g->winner, heads_game[index]->g->team1_name) != 0) && (strcmp(heads_game[index]->g->winner, "tie") != 0))
      {
        strcpy(heads_game[index]->g->winner, heads_game[index]->g->team1_name);
        index_winner = hash(heads_game[index]->g->team1_name, dim);
        index_loser = hash(heads_game[index]->g->team2_name, dim);
        heads_team[index_winner]->t->wins++;
        heads_team[index_loser]->t->wins--;
      }
      else
      {
        if (strcmp(heads_game[index]->g->winner, "tie") == 0)
        {
          strcpy(heads_game[index]->g->winner, heads_game[index]->g->team1_name);
          index_winner = hash(heads_game[index]->g->team1_name, dim);
          heads_team[index_winner]->t->wins++;
        }
        else
        {
          
        }

      }

    }
    else
    {
      if (goals2 > goals1)
      {
        if ((strcmp(heads_game[index]->g->winner, heads_game[index]->g->team2_name) != 0) && (strcmp(heads_game[index]->g->winner, "tie") != 0))
        {
          strcpy(heads_game[index]->g->winner, heads_game[index]->g->team2_name);
          index_winner = hash(heads_game[index]->g->team2_name, dim);
          index_loser = hash(heads_game[index]->g->team1_name, dim);
          heads_team[index_winner]->t->wins++;
          heads_team[index_loser]->t->wins--;
        }
        else
        {
          if (strcmp(heads_game[index]->g->winner, "tie") == 0)
          {
            strcpy(heads_game[index]->g->winner, heads_game[index]->g->team2_name);
            index_winner = hash(heads_game[index]->g->team2_name, dim);
            heads_team[index_winner]->t->wins++;
          }
          else
          {
            
          }

        }

      }
      else
      {
        if ((strcmp(heads_game[index]->g->winner, heads_game[index]->g->team1_name) != 0) && (strcmp(heads_game[index]->g->winner, "tie") != 0))
        {
          strcpy(heads_game[index]->g->winner, "tie");
          index_old_winner = hash(heads_game[index]->g->team2_name, dim);
          heads_team[index_old_winner]->t->wins--;
        }
        else
        {
          if ((strcmp(heads_game[index]->g->winner, heads_game[index]->g->team2_name) != 0) && (strcmp(heads_game[index]->g->winner, "tie") != 0))
          {
            strcpy(heads_game[index]->g->winner, "tie");
            index_old_winner = hash(heads_game[index]->g->team1_name, dim);
            heads_team[index_old_winner]->t->wins--;
          }
          else
          {
            
          }

        }

      }

    }

  }
  else
  {
    printf("%d Jogo inexistente.\n", line);
  }

}

void print_games(int line, int max_index, int *games_index)
{
  int i;
  for (i = 0; i <= max_index; i++)
  {
    if ((games_index[i] != (-1)) && (heads_game[games_index[i]] != 0))
    {
      printf("%d %s %s %s %d %d\n", line, heads_game[games_index[i]]->g->game_name, heads_game[games_index[i]]->g->team1_name, heads_game[games_index[i]]->g->team2_name, heads_game[games_index[i]]->g->score1, heads_game[games_index[i]]->g->score2);
    }
    else
    {
      
    }

  }

}

void print_teams(int line, int max_teams)
{
  if (max_teams > 0)
  {
    printf("%d Melhores", line);
  }
  else
  {
    
  }

}

int main()
{
  int car;
  int line = 1;
  int index_game = 0;
  int i;
  int index_team = 0;
  int dim = 10007;
  int size_games = 10000;
  int *games_index = (int *) malloc(size_games * (sizeof(int)));
  int *aux = games_index;
  init_hash_teams(dim);
  init_hash_games(dim);
  while ((car = getchar()) != 'x')
  {
    switch (car)
    {
      case 'A':
        add_team(line, dim);
        line++;
        index_team++;
        break;

      case 'P':
        look_for_team(line, dim);
        line++;
        break;

      case 'a':
        add_game(line, index_game, dim, games_index);
        line++;
        size_games++;
        index_game++;
        break;

      case 'p':
        look_for_game(line, dim);
        line++;
        break;

      case 's':
        change_score(line, dim);
        line++;
        break;

      case 'r':
        remove_game(line, index_game, dim, games_index);
        line++;
        break;

      case 'l':
        print_games(line, index_game, games_index);
        line++;
        break;

      case 'g':
        print_teams(line, index_team);
        line++;
        break;

    }

  }

  for (i = 0; i < dim; i++)
  {
    free(heads_team[i]);
    free(heads_game[i]);
  }

  free(heads_game);
  free(heads_team);
  free(aux);
  return 0;
}

