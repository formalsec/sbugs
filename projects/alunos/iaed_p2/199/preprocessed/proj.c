/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "hashtable.h"


void a(pGame *g, pTeam *t, int *id, char *name, char *team1, char *team2, int score1, int score2, int line);
void A(pTeam *t, char *name, int *numTeams, int line);
void l(pGame *heads, int gameId, int line);
void p(pGame *g, char *name, int line);
void P(pTeam *t, char *name, int line);
void r(pGame *g, pTeam *t, char *name, int line);
void s(pGame *g, pTeam *t, char *name, int score1, int score2, int line);
void g(pTeam *t, int numTeams, int line);
int compare(const void *p1, const void *p2);
int main()
{
  char game[1023];
  char team1[1023];
  char team2[1023];
  int score1;
  int score2;
  char team[1023];
  int gameId = 0;
  int line = 1;
  int numTeams = 0;
  char command;
  pGame *hashGame = initG(160);
  pTeam *hashTeam = initT(160);
  while (1)
  {
    command = getchar();
    switch (command)
    {
      case 'a':
        getchar();
        for (int game_index = 0; game_index < 10; game_index++)
      {
        game[game_index] = new_sym_var(sizeof(char) * 8);
      }

        game[10 - 1] = '\0';
        for (int team1_index = 0; team1_index < 10; team1_index++)
      {
        team1[team1_index] = new_sym_var(sizeof(char) * 8);
      }

        team1[10 - 1] = '\0';
        for (int team2_index = 0; team2_index < 10; team2_index++)
      {
        team2[team2_index] = new_sym_var(sizeof(char) * 8);
      }

        team2[10 - 1] = '\0';
        score1 = new_sym_var(sizeof(int) * 8);
        score2 = new_sym_var(sizeof(int) * 8);
        a(hashGame, hashTeam, &gameId, game, team1, team2, score1, score2, line);
        break;

      case 'A':
        getchar();
        for (int team_index = 0; team_index < 10; team_index++)
      {
        team[team_index] = new_sym_var(sizeof(char) * 8);
      }

        team[10 - 1] = '\0';
        A(hashTeam, team, &numTeams, line);
        break;

      case 'l':
        getchar();
        l(hashGame, gameId, line);
        break;

      case 'p':
        getchar();
        for (int game_index = 0; game_index < 10; game_index++)
      {
        game[game_index] = new_sym_var(sizeof(char) * 8);
      }

        game[10 - 1] = '\0';
        p(hashGame, game, line);
        break;

      case 'P':
        getchar();
        for (int team_index = 0; team_index < 10; team_index++)
      {
        team[team_index] = new_sym_var(sizeof(char) * 8);
      }

        team[10 - 1] = '\0';
        P(hashTeam, team, line);
        break;

      case 'r':
        getchar();
        for (int game_index = 0; game_index < 10; game_index++)
      {
        game[game_index] = new_sym_var(sizeof(char) * 8);
      }

        game[10 - 1] = '\0';
        r(hashGame, hashTeam, game, line);
        break;

      case 's':
        getchar();
        for (int game_index = 0; game_index < 10; game_index++)
      {
        game[game_index] = new_sym_var(sizeof(char) * 8);
      }

        game[10 - 1] = '\0';
        score1 = new_sym_var(sizeof(int) * 8);
        score2 = new_sym_var(sizeof(int) * 8);
        s(hashGame, hashTeam, game, score1, score2, line);
        break;

      case 'g':
        getchar();
        g(hashTeam, numTeams, line);
        break;

      case 'x':
        freeG(hashGame, 160);
        freeT(hashTeam, 160);
        return 0;

    }

    if (command != '\n')
    {
      line++;
    }
    else
    {
      
    }

  }

  freeG(hashGame, 160);
  freeT(hashTeam, 160);
  return 1;
}

void a(pGame *g, pTeam *t, int *id, char *name, char *team1, char *team2, int score1, int score2, int line)
{
  Game *game;
  Team *team;
  if (searchG(g, name, 160) != 0)
  {
    printf("%d Jogo existente.\n", line);
    return;
  }
  else
  {
    
  }

  if ((searchT(t, team1, 160) == 0) || (searchT(t, team2, 160) == 0))
  {
    printf("%d Equipa inexistente.\n", line);
    return;
  }
  else
  {
    
  }

  game = newG(*id, name, team1, team2, score1, score2);
  insertG(g, game, 160);
  (*id)++;
  if (score1 == score2)
  {
    return;
  }
  else
  {
    
  }

  if (score1 > score2)
  {
    team = searchT(t, team1, 160);
  }
  else
  {
    team = searchT(t, team2, 160);
  }

  team->cont++;
}

void A(pTeam *t, char *name, int *numTeams, int line)
{
  Team *team;
  if (searchT(t, name, 160) != 0)
  {
    printf("%d Equipa existente.\n", line);
    return;
  }
  else
  {
    
  }

  team = newT(name);
  insertT(t, team, 160);
  (*numTeams)++;
}

void l(pGame *heads, int gameId, int line)
{
  int i;
  Game **table = malloc((sizeof(Game *)) * gameId);
  for (i = 0; i < gameId; i++)
  {
    table[i] = 0;
  }

  for (i = 0; i < 160; i++)
  {
    pGame temp = heads[i];
    while (temp != 0)
    {
      table[temp->game->id] = temp->game;
      temp = temp->next;
    }

  }

  for (i = 0; i < gameId; i++)
  {
    if (table[i] == 0)
    {
      continue;
    }
    else
    {
      
    }

    printf("%d %s %s %s %d %d\n", line, table[i]->name, table[i]->team1, table[i]->team2, table[i]->score1, table[i]->score2);
  }

  free(table);
}

void p(pGame *g, char *name, int line)
{
  Game *game = searchG(g, name, 160);
  if (game == 0)
  {
    printf("%d Jogo inexistente.\n", line);
  }
  else
  {
    printf("%d %s %s %s %d %d\n", line, game->name, game->team1, game->team2, game->score1, game->score2);
  }

}

void P(pTeam *t, char *name, int line)
{
  Team *team = searchT(t, name, 160);
  if (team == 0)
  {
    printf("%d Equipa inexistente.\n", line);
  }
  else
  {
    printf("%d %s %d\n", line, team->name, team->cont);
  }

}

void r(pGame *g, pTeam *t, char *name, int line)
{
  Game *game = searchG(g, name, 160);
  Team *team;
  char *prevWinner;
  if (game == 0)
  {
    printf("%d Jogo inexistente.\n", line);
    return;
  }
  else
  {
    
  }

  if (game->score1 != game->score2)
  {
    if (game->score1 > game->score2)
    {
      prevWinner = game->team1;
    }
    else
    {
      prevWinner = game->team2;
    }

    team = searchT(t, prevWinner, 160);
    team->cont--;
  }
  else
  {
    
  }

  deleteG(g, name, 160);
}

void s(pGame *g, pTeam *t, char *name, int score1, int score2, int line)
{
  char *prevWinner;
  char *newWinner;
  Team *team1;
  Team *team2;
  Game *game = searchG(g, name, 160);
  if (game == 0)
  {
    printf("%d Jogo inexistente.\n", line);
    return;
  }
  else
  {
    
  }

  if (score1 == score2)
  {
    if (game->score1 != game->score2)
    {
      if (game->score1 > game->score2)
      {
        prevWinner = game->team1;
      }
      else
      {
        prevWinner = game->team2;
      }

      team2 = searchT(t, prevWinner, 160);
      team2->cont--;
    }
    else
    {
      
    }

  }
  else
  {
    if (game->score1 == game->score2)
    {
      if (score1 > score2)
      {
        newWinner = game->team1;
      }
      else
      {
        newWinner = game->team2;
      }

      team1 = searchT(t, newWinner, 160);
      team1->cont++;
    }
    else
    {
      if (game->score1 > game->score2)
      {
        prevWinner = game->team1;
      }
      else
      {
        prevWinner = game->team2;
      }

      if (score1 > score2)
      {
        newWinner = game->team1;
      }
      else
      {
        newWinner = game->team2;
      }

      if (newWinner != prevWinner)
      {
        team1 = searchT(t, newWinner, 160);
        team1->cont++;
        team2 = searchT(t, prevWinner, 160);
        team2->cont--;
      }
      else
      {
        
      }

    }

  }

  game->score1 = score1;
  game->score2 = score2;
}

int compare(const void *p1, const void *p2)
{
  return strcmp(*((char * const *) p1), *((char * const *) p2));
}

void g(pTeam *t, int numTeams, int line)
{
  int i;
  int c = 0;
  int j = 0;
  int max = 0;
  char **table;
  if (numTeams == 0)
  {
    return;
  }
  else
  {
    
  }

  for (i = 0; i < 160; i++)
  {
    pTeam temp = t[i];
    while (temp != 0)
    {
      if (max == temp->team->cont)
      {
        c++;
      }
      else
      {
        
      }

      if (max < temp->team->cont)
      {
        max = temp->team->cont;
        c = 1;
      }
      else
      {
        
      }

      temp = temp->next;
    }

  }

  table = malloc((sizeof(char *)) * c);
  for (i = 0; i < 160; i++)
  {
    pTeam temp = t[i];
    while (temp != 0)
    {
      if (max == temp->team->cont)
      {
        table[j] = temp->team->name;
        j++;
      }
      else
      {
        
      }

      temp = temp->next;
    }

  }

  qsort(table, c, sizeof(char *), compare);
  printf("%d Melhores %d\n", line, max);
  for (i = 0; i < c; i++)
  {
    printf("%d * %s\n", line, table[i]);
  }

  free(table);
}

