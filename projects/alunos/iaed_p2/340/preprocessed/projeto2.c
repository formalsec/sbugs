#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "equipas.h"
#include "hashtable_equipas.h"
#include "jogos.h"
#include "hashtable_jogos.h"
#include "lista_ligada_nomes.h"


void adiciona_equipa(table_e **heads, int M, int linha)
{
  Equipa *x;
  char nome[1024];
  int key;
  for (int nome_index = 0; nome_index < 10; nome_index++)
  {
    nome[nome_index] = new_sym_var(sizeof(char) * 8);
  }

  nome[10 - 1] = '\0';
  key = hash(nome, M);
  if ((heads[key] != 0) && ((x = encontra(heads[key]->equipas, nome)) != 0))
  {
    printf("%d Equipa existente.\n", linha);
  }
  else
  {
    x = cria_equipa(nome);
    adiciona_e(heads, x, M);
  }

}

void procura_e(table_e **heads, int M, int linha)
{
  Equipa *x;
  char nome[1024];
  for (int nome_index = 0; nome_index < 10; nome_index++)
  {
    nome[nome_index] = new_sym_var(sizeof(char) * 8);
  }

  nome[10 - 1] = '\0';
  if ((x = procura_equipa_hash(heads, nome, M)) == 0)
  {
    printf("%d Equipa inexistente.\n", linha);
  }
  else
  {
    printf("%d %s %d\n", linha, x->nome, x->ganhos);
  }

}

void adiciona_jogo(table_e **head_e, table_j **heads, Lista **ultimo_jogo, int M, int linha, Lista **lista)
{
  Jogo *x;
  Lista *jogo;
  char nome_j[1024];
  char equipa1[1024];
  char equipa2[1024];
  int key;
  int score1;
  int score2;
  for (int nome_j_index = 0; nome_j_index < 10; nome_j_index++)
  {
    nome_j[nome_j_index] = new_sym_var(sizeof(char) * 8);
  }

  nome_j[10 - 1] = '\0';
  for (int equipa1_index = 0; equipa1_index < 10; equipa1_index++)
  {
    equipa1[equipa1_index] = new_sym_var(sizeof(char) * 8);
  }

  equipa1[10 - 1] = '\0';
  for (int equipa2_index = 0; equipa2_index < 10; equipa2_index++)
  {
    equipa2[equipa2_index] = new_sym_var(sizeof(char) * 8);
  }

  equipa2[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  key = hash(nome_j, M);
  if ((heads[key] != 0) && ((x = encontra_j(heads[key]->jogos, nome_j)) != 0))
  {
    printf("%d Jogo existente.\n", linha);
  }
  else
  {
    if ((procura_equipa_hash(head_e, equipa1, M) == 0) || (procura_equipa_hash(head_e, equipa2, M) == 0))
    {
      printf("%d Equipa inexistente.\n", linha);
    }
    else
    {
      jogo = cria_elemento(nome_j);
      adiciona_elemento(lista, jogo, ultimo_jogo);
      x = cria_jogo(nome_j, equipa1, equipa2, score1, score2);
      adiciona_j(heads, x, M);
      if (score1 != score2)
      {
        (score1 > score2) ? (altera_ganhos(procura_equipa_hash(head_e, equipa1, M), 1)) : (altera_ganhos(procura_equipa_hash(head_e, equipa2, M), 1));
      }
      else
      {
        
      }

    }

  }

}

void procura_j(table_j **heads, int M, int linha)
{
  Jogo *x;
  char nome[1024];
  for (int nome_index = 0; nome_index < 10; nome_index++)
  {
    nome[nome_index] = new_sym_var(sizeof(char) * 8);
  }

  nome[10 - 1] = '\0';
  if ((x = procura_jogo_hash(heads, nome, M)) == 0)
  {
    printf("%d Jogo inexistente.\n", linha);
  }
  else
  {
    printf("%d %s %s %s %d %d\n", linha, x->nome_jogo, x->equipa1, x->equipa2, x->score1, x->score2);
  }

}

void lista_jogos(table_j **head, Lista *jogos, int M, int linha)
{
  Jogo *x;
  for (; jogos != 0; jogos = jogos->next)
  {
    x = procura_jogo_hash(head, jogos->nome, M);
    printf("%d %s %s %s %d %d\n", linha, x->nome_jogo, x->equipa1, x->equipa2, x->score1, x->score2);
  }

}

void remove_jogo(table_j **heads_j, table_e **heads_e, Lista **listas, Lista **ultimo_jogo, int M, int linha_input)
{
  char nome[1024];
  Jogo *jogo;
  Equipa *equipa;
  for (int nome_index = 0; nome_index < 10; nome_index++)
  {
    nome[nome_index] = new_sym_var(sizeof(char) * 8);
  }

  nome[10 - 1] = '\0';
  if ((jogo = procura_jogo_hash(heads_j, nome, M)) == 0)
  {
    printf("%d Jogo inexistente.\n", linha_input);
  }
  else
  {
    if (jogo->score1 > jogo->score2)
    {
      equipa = procura_equipa_hash(heads_e, jogo->equipa1, M);
      altera_ganhos(equipa, 0);
    }
    else
    {
      if (jogo->score1 < jogo->score2)
      {
        equipa = procura_equipa_hash(heads_e, jogo->equipa2, M);
        altera_ganhos(equipa, 0);
      }
      else
      {
        
      }

    }

    remove_j(heads_j, nome, M);
    ultimo_jogo = remove_el(listas, ultimo_jogo, nome);
  }

}

void altera_score(table_j **jogos, table_e **equipas, int M, int linha_input)
{
  Jogo *x;
  Equipa *e1;
  Equipa *e2;
  char nome[1024];
  int s1;
  int s2;
  for (int nome_index = 0; nome_index < 10; nome_index++)
  {
    nome[nome_index] = new_sym_var(sizeof(char) * 8);
  }

  nome[10 - 1] = '\0';
  s1 = new_sym_var(sizeof(int) * 8);
  s2 = new_sym_var(sizeof(int) * 8);
  x = procura_jogo_hash(jogos, nome, M);
  if (x != 0)
  {
    e1 = procura_equipa_hash(equipas, x->equipa1, M);
    e2 = procura_equipa_hash(equipas, x->equipa2, M);
    if (((x->score1 < x->score2) || (x->score1 == x->score2)) && (s1 > s2))
    {
      altera_ganhos(e1, 1);
    }
    else
    {
      if ((x->score1 > x->score2) && ((s2 > s1) || (s2 == s1)))
      {
        altera_ganhos(e1, 0);
      }
      else
      {
        
      }

    }

    if ((x->score1 < x->score2) && ((s1 > s2) || (s1 == s2)))
    {
      altera_ganhos(e2, 0);
    }
    else
    {
      if (((x->score1 > x->score2) || (x->score1 == x->score2)) && (s1 < s2))
      {
        altera_ganhos(e2, 1);
      }
      else
      {
        
      }

    }

    x->score1 = s1;
    x->score2 = s2;
  }
  else
  {
    printf("%d Jogo inexistente.\n", linha_input);
  }

}

void swap(char **arr, int i, int l)
{
  char aux[1024];
  strcpy(aux, arr[i]), strcpy(arr[i], arr[l]), strcpy(arr[l], aux);
}

void heapify(char **arr, int n, int i)
{
  int largest = i;
  int l = (2 * i) + 1;
  int r = (2 * i) + 2;
  if ((l < n) && (strcmp(arr[l], arr[largest]) < 0))
  {
    largest = l;
  }
  else
  {
    
  }

  if ((r < n) && (strcmp(arr[r], arr[largest]) < 0))
  {
    largest = r;
  }
  else
  {
    
  }

  if (largest != i)
  {
    swap(arr, i, largest);
    heapify(arr, n, largest);
  }
  else
  {
    
  }

}

void heapSort(char **arr, int n)
{
  int i;
  for (i = (n / 2) - 1; i >= 0; i--)
    heapify(arr, n, i);

  for (i = n - 1; i > 0; i--)
  {
    swap(arr, 0, i);
    heapify(arr, i, 0);
  }

}

void mais_ganhos_g(table_e **heads, int M, int linha_input)
{
  int Max;
  int i;
  int count = 0;
  int i2;
  Equipa *x;
  char **nomes;
  Max = mais_ganhos(heads, M, &count);
  if (count > 0)
  {
    nomes = malloc((sizeof(char *)) * count);
    for (i = 0; i < count; i++)
    {
      nomes[i] = malloc((sizeof(char)) * 1024);
    }

    for (i = 0, i2 = 0; i < M; i++)
    {
      if (heads[i] != 0)
      {
        for (x = heads[i]->equipas; x != 0; x = x->next)
        {
          if (x->ganhos == Max)
          {
            strcpy(nomes[i2], x->nome);
            i2++;
          }
          else
          {
            
          }

        }

      }
      else
      {
        
      }

    }

    heapSort(nomes, i2);
    printf("%d Melhores %d\n", linha_input, Max);
    for (i2 = i2 - 1; i2 >= 0; i2--)
    {
      printf("%d * %s\n", linha_input, nomes[i2]);
    }

    for (count = count - 1; count >= 0; count--)
    {
      free(nomes[count]);
    }

    free(nomes);
  }
  else
  {
    
  }

}

void free_lista(Lista **heads)
{
  Lista *x;
  Lista *head;
  head = heads[0];
  for (x = head; head != 0;)
  {
    head = head->next;
    free_el(x);
    x = head;
  }

  free(heads);
}

int main()
{
  table_e **heads = 0;
  table_j **heads_j = 0;
  Lista **listas = 0;
  Lista **ultimo_jogo = malloc(sizeof(Lista));
  int size_hash = 1439;
  int linha_input = 0;
  char c;
  heads = inicializa_e(heads, size_hash);
  heads_j = inicializa_j(heads_j, size_hash);
  listas = inicializa_lista(listas);
  while (1)
  {
    c = new_sym_var(sizeof(char) * 8);
    if (c == 'a')
    {
      linha_input++;
      adiciona_jogo(heads, heads_j, ultimo_jogo, size_hash, linha_input, listas);
    }
    else
    {
      
    }

    if (c == 'A')
    {
      linha_input++;
      adiciona_equipa(heads, size_hash, linha_input);
    }
    else
    {
      if (c == 'P')
      {
        linha_input++;
        procura_e(heads, size_hash, linha_input);
      }
      else
      {
        if (c == 'l')
        {
          linha_input++;
          lista_jogos(heads_j, listas[0], size_hash, linha_input);
        }
        else
        {
          if (c == 'r')
          {
            linha_input++;
            remove_jogo(heads_j, heads, listas, ultimo_jogo, size_hash, linha_input);
          }
          else
          {
            if (c == 'p')
            {
              linha_input++;
              procura_j(heads_j, size_hash, linha_input);
            }
            else
            {
              if (c == 's')
              {
                linha_input++;
                altera_score(heads_j, heads, size_hash, linha_input);
              }
              else
              {
                if (c == 'g')
                {
                  linha_input++;
                  mais_ganhos_g(heads, size_hash, linha_input);
                }
                else
                {
                  if (c == 'x')
                  {
                    break;
                  }
                  else
                  {
                    
                  }

                }

              }

            }

          }

        }

      }

    }

  }

  free_hash_equipas(heads, size_hash);
  free_hash_jogos(heads_j, size_hash);
  free_lista(listas);
  free(ultimo_jogo);
  return 0;
}

