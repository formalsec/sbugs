#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include "proj2.h"


int main()
{
  hash_table *ht_teams;
  hash_table *ht_games;
  l_list *l_teams;
  l_list *l_games;
  l_ht_info *info = calloc(1, sizeof(l_ht_info));
  ht_teams = create_ht();
  ht_games = create_ht();
  l_teams = create_l_list();
  l_games = create_l_list();
  srand(time(0));
  info->ht_teams = ht_teams;
  info->ht_games = ht_games;
  info->l_teams = l_teams;
  info->l_games = l_games;
  commands_loop(info);
  free_l_list(l_teams, &free_team);
  free_l_list(l_games, &free_game);
  ht_delete_ht(ht_games);
  ht_delete_ht(ht_teams);
  free(info);
  return 0;
}

void free_team(void *ptr)
{
  team *p_team = (team *) ptr;
  free(p_team->name);
  free(p_team);
}

void free_game(void *ptr)
{
  game *p_game = (game *) ptr;
  free(p_game->name);
  free(p_game->team1);
  free(p_game->team2);
  free(p_game);
}

int commands_loop(l_ht_info *info)
{
  int cmd_counter = 1;
  char io_buffer[8192];
  char cmd = '\0';
  while (1)
  {
    fgets(io_buffer, 8192, stdin);
    if (1)
    {
      cmd = new_sym_var(sizeof(char) * 8);
      switch (cmd)
      {
        case 'a':
          add_game_proc(io_buffer, info, cmd_counter);
          break;

        case 'A':
          add_team_proc(io_buffer, info, cmd_counter);
          break;

        case 'l':
          list_games_proc(info, cmd_counter);
          break;

        case 'p':
          search_game_proc(io_buffer, info, cmd_counter);
          break;

        case 'P':
          search_team_proc(io_buffer, info, cmd_counter);
          break;

        case 'r':
          delete_game_proc(io_buffer, info, cmd_counter);
          break;

        case 's':
          change_game_score_proc(io_buffer, info, cmd_counter);
          break;

        case 'g':
          teams_most_wins_proc(info, cmd_counter);
          break;

        case 'x':
          return 0;

      }

      cmd_counter++;
    }
    else
    {
      
    }

  }

}

int add_game_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  char tm1[1024];
  char tm2[1024];
  int score1 = 0;
  int score2 = 0;
  game *p_game;
  team *p_team1;
  team *p_team2;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  for (int tm1_index = 0; tm1_index < 10; tm1_index++)
  {
    tm1[tm1_index] = new_sym_var(sizeof(char) * 8);
  }

  tm1[10 - 1] = '\0';
  for (int tm2_index = 0; tm2_index < 10; tm2_index++)
  {
    tm2[tm2_index] = new_sym_var(sizeof(char) * 8);
  }

  tm2[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  if (search_game_by_name(name, info, &p_game))
  {
    printf("%d Jogo existente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  if (!search_team_by_name(tm1, info, &p_team1))
  {
    printf("%d Equipa inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  if (!search_team_by_name(tm2, info, &p_team2))
  {
    printf("%d Equipa inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  if (score1 > score2)
  {
    p_team1->games_won++;
  }
  else
  {
    
  }

  if (score1 < score2)
  {
    p_team2->games_won++;
  }
  else
  {
    
  }

  add_game(info, name, tm1, tm2, score1, score2);
  return 1;
}

void add_game(l_ht_info *info, char *name, char *tm1, char *tm2, int score1, int score2)
{
  char *p_name;
  char *p_tm1;
  char *p_tm2;
  int len;
  ulong key = ht_key_from_str(name);
  ht_node *p_ht_node = create_ht_node();
  l_node *p_l_node = create_l_node();
  game *p_game = malloc(sizeof(game));
  len = strlen(name);
  p_name = malloc((sizeof(char)) * (len + 1));
  strcpy(p_name, name);
  len = strlen(tm1);
  p_tm1 = malloc((sizeof(char)) * (len + 1));
  strcpy(p_tm1, tm1);
  len = strlen(tm2);
  p_tm2 = malloc((sizeof(char)) * (len + 1));
  strcpy(p_tm2, tm2);
  p_game->name = p_name;
  p_game->team1 = p_tm1;
  p_game->team2 = p_tm2;
  p_game->score1 = score1;
  p_game->score2 = score2;
  p_l_node->info_struct = p_game;
  p_ht_node->info_struct = p_l_node;
  l_list_add_node_end(info->l_games, p_l_node);
  ht_insert_node(info->ht_games, p_ht_node, key);
  return;
}

int add_team_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  team *p_team;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  if (search_team_by_name(name, info, &p_team))
  {
    printf("%d Equipa existente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  add_team(info, name);
  return 1;
}

void add_team(l_ht_info *info, char *name)
{
  char *p_name;
  int len;
  ulong key = ht_key_from_str(name);
  ht_node *p_ht_node = create_ht_node();
  l_node *p_l_node = create_l_node();
  team *p_team = calloc(1, sizeof(team));
  len = strlen(name);
  p_name = malloc((sizeof(char)) * (len + 1));
  strcpy(p_name, name);
  *(p_name + len) = '\0';
  p_team->name = p_name;
  p_team->games_won = 0;
  p_l_node->info_struct = p_team;
  p_ht_node->info_struct = p_l_node;
  l_list_add_node_end(info->l_teams, p_l_node);
  ht_insert_node(info->ht_teams, p_ht_node, key);
  return;
}

int list_games_proc(l_ht_info *info, int cmd_ctr)
{
  l_list *l_games = info->l_games;
  l_node *p_l_node = l_games->head;
  game *p_game;
  int scr1;
  int scr2;
  for (; p_l_node != 0; p_l_node = p_l_node->next)
  {
    p_game = (game *) p_l_node->info_struct;
    scr1 = p_game->score1;
    scr2 = p_game->score2;
    printf("%d %s %s %s %d %d\n", cmd_ctr, p_game->name, p_game->team1, p_game->team2, scr1, scr2);
  }

  return 1;
}

int search_game_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  char *tm1;
  char *tm2;
  int score1;
  int score2;
  game *p_game = 0;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  search_game_by_name(name, info, &p_game);
  if (p_game == 0)
  {
    printf("%d Jogo inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  tm1 = p_game->team1;
  tm2 = p_game->team2;
  score1 = p_game->score1;
  score2 = p_game->score2;
  printf("%d %s %s %s %d %d\n", cmd_ctr, name, tm1, tm2, score1, score2);
  return 1;
}

int search_team_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  int games_won;
  team *p_team = 0;
  team **ptr_team_ptr = &p_team;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  search_team_by_name(name, info, ptr_team_ptr);
  if (p_team == 0)
  {
    printf("%d Equipa inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  games_won = p_team->games_won;
  printf("%d %s %d\n", cmd_ctr, name, games_won);
  return 1;
}

int delete_game_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  ulong key;
  ht_node *p_ht_node;
  l_node *p_l_node;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  key = ht_key_from_str(name);
  p_ht_node = ht_get_base_node(info->ht_games, key);
  if (p_ht_node == 0)
  {
    printf("%d Jogo inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  for (; p_ht_node != 0; p_ht_node = p_ht_node->next)
  {
    p_l_node = (l_node *) p_ht_node->info_struct;
    if (strcmp(((game *) p_l_node->info_struct)->name, name) == 0)
    {
      break;
    }
    else
    {
      
    }

    if (p_ht_node->next == 0)
    {
      printf("%d Jogo inexistente.\n", cmd_ctr);
      return 0;
    }
    else
    {
      
    }

  }

  dgp_update_games_won(info, (game *) p_l_node->info_struct);
  l_list_remove_node(info->l_games, p_l_node, free_game);
  ht_delete_node(info->ht_games, p_ht_node, key);
  return 1;
}

void dgp_update_games_won(l_ht_info *info, game *p_game)
{
  team *p_team1;
  team *p_team2;
  search_team_by_name(p_game->team1, info, &p_team1);
  search_team_by_name(p_game->team2, info, &p_team2);
  if (p_game->score1 > p_game->score2)
  {
    p_team1->games_won--;
  }
  else
  {
    
  }

  if (p_game->score1 < p_game->score2)
  {
    p_team2->games_won--;
  }
  else
  {
    
  }

  return;
}

int change_game_score_proc(char *io_buffer, l_ht_info *info, int cmd_ctr)
{
  char name[1024];
  int scr1;
  int scr2;
  game *p_game = 0;
  for (int name_index = 0; name_index < 10; name_index++)
  {
    name[name_index] = new_sym_var(sizeof(char) * 8);
  }

  name[10 - 1] = '\0';
  scr1 = new_sym_var(sizeof(int) * 8);
  scr2 = new_sym_var(sizeof(int) * 8);
  if (!search_game_by_name(name, info, &p_game))
  {
    printf("%d Jogo inexistente.\n", cmd_ctr);
    return 0;
  }
  else
  {
    
  }

  cgsp_update_games_won(info, p_game, scr1, scr2);
  p_game->score1 = scr1;
  p_game->score2 = scr2;
  return 1;
}

void cgsp_update_games_won(l_ht_info *info, game *p_game, int scr1, int scr2)
{
  int pre_scr1;
  int pre_scr2;
  team *p_team1;
  team *p_team2;
  pre_scr1 = p_game->score1;
  pre_scr2 = p_game->score2;
  search_team_by_name(p_game->team1, info, &p_team1);
  search_team_by_name(p_game->team2, info, &p_team2);
  if (pre_scr1 > pre_scr2)
  {
    if (scr1 == scr2)
    {
      p_team1->games_won--;
    }
    else
    {
      
    }

    if (scr1 < scr2)
    {
      p_team1->games_won--;
      p_team2->games_won++;
    }
    else
    {
      
    }

  }
  else
  {
    
  }

  if (pre_scr1 < pre_scr2)
  {
    if (scr1 == scr2)
    {
      p_team2->games_won--;
    }
    else
    {
      
    }

    if (scr1 > scr2)
    {
      p_team1->games_won++;
      p_team2->games_won--;
    }
    else
    {
      
    }

  }
  else
  {
    
  }

  if (pre_scr1 == pre_scr2)
  {
    if (scr1 > scr2)
    {
      p_team1->games_won++;
    }
    else
    {
      
    }

    if (scr1 < scr2)
    {
      p_team2->games_won++;
    }
    else
    {
      
    }

  }
  else
  {
    
  }

  return;
}

int teams_most_wins_proc(l_ht_info *info, int cmd_ctr)
{
  l_list *l_max_winners = 0;
  l_node *lst_node;
  l_node *temp_l_node;
  team *p_team;
  int max_wins = -1;
  int n_winners;
  if (info->l_teams->head == 0)
  {
    return 0;
  }
  else
  {
    
  }

  for (lst_node = info->l_teams->head; lst_node != 0; lst_node = lst_node->next)
  {
    p_team = (team *) lst_node->info_struct;
    if (p_team->games_won > max_wins)
    {
      max_wins = p_team->games_won;
      n_winners = 0;
      free_l_list_and_node_only(l_max_winners);
      l_max_winners = create_l_list();
    }
    else
    {
      
    }

    if (p_team->games_won == max_wins)
    {
      temp_l_node = create_l_node();
      temp_l_node->info_struct = (void *) p_team;
      l_list_add_node_end(l_max_winners, temp_l_node);
      n_winners++;
    }
    else
    {
      
    }

  }

  tmwp_sort_print(l_max_winners, n_winners, max_wins, cmd_ctr);
  free_l_list_and_node_only(l_max_winners);
  return 1;
}

void tmwp_sort_print(l_list *l_winners, int n_winners, int max_wins, int cmd_ctr)
{
  int title_flag = 0;
  int arr_pos = 0;
  char **chr_arr = malloc((sizeof(char *)) * n_winners);
  l_node *lst_node;
  for (lst_node = l_winners->head; lst_node != 0; arr_pos++, lst_node = lst_node->next)
  {
    *(chr_arr + arr_pos) = ((team *) lst_node->info_struct)->name;
  }

  quicksort(chr_arr, 0, n_winners - 1, 0, swap_char);
  for (arr_pos = 0; arr_pos < n_winners; arr_pos++)
  {
    if (!title_flag)
    {
      printf("%d Melhores %d\n", cmd_ctr, max_wins);
      title_flag = 1;
    }
    else
    {
      
    }

    printf("%d * %s\n", cmd_ctr, *(chr_arr + arr_pos));
  }

  free(chr_arr);
  return;
}

void swap_char(int idx_1, int idx_2, char **chr_arr, void *info_struct)
{
  char *p_chr_temp;
  (void) info_struct;
  p_chr_temp = *(chr_arr + idx_1);
  *(chr_arr + idx_1) = *(chr_arr + idx_2);
  *(chr_arr + idx_2) = p_chr_temp;
  return;
}

int search_game_by_name(char *name, l_ht_info *info, game **p_game)
{
  ulong key = ht_key_from_str(name);
  ht_node *p_ht_node;
  l_node *node;
  p_ht_node = ht_get_base_node(info->ht_games, key);
  for (; p_ht_node != 0; p_ht_node = p_ht_node->next)
  {
    node = (l_node *) p_ht_node->info_struct;
    if (strcmp(((game *) node->info_struct)->name, name) == 0)
    {
      *p_game = (game *) node->info_struct;
      return 1;
    }
    else
    {
      
    }

  }

  *p_game = 0;
  return 0;
}

int search_team_by_name(char *name, l_ht_info *info, team **p_team)
{
  ulong key = ht_key_from_str(name);
  ht_node *p_ht_node;
  l_node *node;
  p_ht_node = ht_get_base_node(info->ht_teams, key);
  for (; p_ht_node != 0; p_ht_node = p_ht_node->next)
  {
    node = (l_node *) p_ht_node->info_struct;
    if (strcmp(((team *) node->info_struct)->name, name) == 0)
    {
      *p_team = (team *) node->info_struct;
      return 1;
    }
    else
    {
      
    }

  }

  *p_team = 0;
  return 0;
}

