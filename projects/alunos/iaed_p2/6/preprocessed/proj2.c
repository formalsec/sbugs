#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "Hashtable.h"
#include "Linkedlist.h"


int NL = 0;
void addMatch(hash_table *matches, hash_table *teams, link *ordered_matches, link *ordered_teams, char *command);
void addTeam(hash_table *teams, link *ordered_teams, char *command);
void listMatches(link ordered_matches);
void searchMatch(hash_table *matches, char *command);
void searchTeam(hash_table *teams, char *command);
void removeMatch(hash_table *matches, hash_table *teams, link *ordered_matches, link *ordered_teams, char *command);
void changeScore(hash_table *matches, hash_table *teams, link *ordered_teams, char *command);
void getTopTeams(link ordered_teams);
int main()
{
  char command[3076];
  hash_table *matches = hash_table_init(101);
  hash_table *teams = hash_table_init(29);
  link ordered_teams = 0;
  link ordered_matches = 0;
  while (1)
  {
    fgets(command, 3076, stdin);
    NL++;
    switch (command[0])
    {
      case 'a':
        addMatch(matches, teams, &ordered_matches, &ordered_teams, command);
        break;

      case 'A':
        addTeam(teams, &ordered_teams, command);
        break;

      case 'l':
        listMatches(ordered_matches);
        break;

      case 'p':
        searchMatch(matches, command);
        break;

      case 'P':
        searchTeam(teams, command);
        break;

      case 'r':
        removeMatch(matches, teams, &ordered_matches, &ordered_teams, command);
        break;

      case 's':
        changeScore(matches, teams, &ordered_teams, command);
        break;

      case 'g':
        getTopTeams(ordered_teams);
        break;

      case 'x':
        deleteList(&ordered_teams);
        deleteList(&ordered_matches);
        hash_table_free(matches);
        hash_table_free(teams);
        return 0;

      default:
        printf("ERROR: Unknown command\n");

    }

  }

  return 1;
}

void addMatch(hash_table *matches, hash_table *teams, link *ordered_matches, link *ordered_teams, char *command)
{
  char *token;
  char *name;
  char *team1;
  char *team2;
  int score1;
  int score2;
  Item item;
  Item item1;
  Item item2;
  Team team;
  token = strtok(command, " ");
  name = (token = strtok(0, ":"));
  if (hash_table_search(matches, name) != 0)
  {
    printf("%d Jogo existente.\n", NL);
    return;
  }
  else
  {
    
  }

  team1 = (token = strtok(0, ":"));
  if ((item1 = hash_table_search(teams, team1)) == 0)
  {
    printf("%d Equipa inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  team2 = (token = strtok(0, ":"));
  if ((item2 = hash_table_search(teams, team2)) == 0)
  {
    printf("%d Equipa inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  score1 = atoi(token = strtok(0, ":"));
  score2 = atoi(token = strtok(0, "\n"));
  item = newMatch(name, team1, team2, score1, score2);
  hash_table_insert(matches, item);
  insertEnd(ordered_matches, item);
  if (score1 > score2)
  {
    team = item1->content;
    team->record++;
    removeNode(ordered_teams, item1);
    insertSorted(ordered_teams, item1);
  }
  else
  {
    if (score2 > score1)
    {
      team = item2->content;
      team->record++;
      removeNode(ordered_teams, item2);
      insertSorted(ordered_teams, item2);
    }
    else
    {
      
    }

  }

}

void addTeam(hash_table *teams, link *ordered_teams, char *command)
{
  char *token;
  char *name;
  Item item;
  token = strtok(command, " ");
  name = (token = strtok(0, "\n"));
  if (hash_table_search(teams, name) != 0)
  {
    printf("%d Equipa existente.\n", NL);
    return;
  }
  else
  {
    item = newTeam(name);
    hash_table_insert(teams, item);
    insertSorted(ordered_teams, item);
  }

}

void listMatches(link ordered_matches)
{
  link node = ordered_matches;
  while (node != 0)
  {
    printf("%d ", NL);
    printItem(node->item);
    node = node->next;
  }

}

void searchMatch(hash_table *matches, char *command)
{
  char *token;
  char *name;
  Item item;
  token = strtok(command, " ");
  name = (token = strtok(0, "\n"));
  if ((item = hash_table_search(matches, name)) == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    printf("%d ", NL);
    printItem(item);
  }

}

void searchTeam(hash_table *teams, char *command)
{
  char *token;
  char *name;
  Item item;
  token = strtok(command, " ");
  name = (token = strtok(0, "\n"));
  if ((item = hash_table_search(teams, name)) == 0)
  {
    printf("%d Equipa inexistente.\n", NL);
  }
  else
  {
    printf("%d ", NL);
    printItem(item);
  }

}

void removeMatch(hash_table *matches, hash_table *teams, link *ordered_matches, link *ordered_teams, char *command)
{
  char *token;
  char *name;
  Item item;
  Item item_team;
  Match match;
  Team team;
  token = strtok(command, " ");
  name = (token = strtok(0, "\n"));
  if ((item = hash_table_search(matches, name)) == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    item = hash_table_remove(matches, name);
    removeNode(ordered_matches, item);
    match = item->content;
    if (match->score1 != match->score2)
    {
      if (match->score1 > match->score2)
      {
        item_team = hash_table_search(teams, match->team1);
        team = item_team->content;
      }
      else
      {
        if (match->score2 > match->score1)
        {
          item_team = hash_table_search(teams, match->team2);
          team = item_team->content;
        }
        else
        {
          
        }

      }

      team->record--;
      removeNode(ordered_teams, item_team);
      insertSorted(ordered_teams, item_team);
    }
    else
    {
      
    }

    freeItem(item);
  }

}

void changeScore(hash_table *matches, hash_table *teams, link *ordered_teams, char *command)
{
  char *token;
  char *name;
  int score1;
  int score2;
  Item item;
  Match match;
  Team team;
  ;
  token = strtok(command, " ");
  name = (token = strtok(0, ":"));
  if ((item = hash_table_search(matches, name)) == 0)
  {
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    score1 = atoi(token = strtok(0, ":"));
    score2 = atoi(token = strtok(0, "\n"));
    match = item->content;
    if (match->score1 != match->score2)
    {
      if (match->score1 > match->score2)
      {
        item = hash_table_search(teams, match->team1);
        team = item->content;
      }
      else
      {
        if (match->score2 > match->score1)
        {
          item = hash_table_search(teams, match->team2);
          team = item->content;
        }
        else
        {
          
        }

      }

      team->record--;
      removeNode(ordered_teams, item);
      insertSorted(ordered_teams, item);
    }
    else
    {
      
    }

    match->score1 = score1;
    match->score2 = score2;
    if (score1 > score2)
    {
      item = hash_table_search(teams, match->team1);
      team = item->content;
      team->record++;
      removeNode(ordered_teams, item);
      insertSorted(ordered_teams, item);
    }
    else
    {
      if (score2 > score1)
      {
        item = hash_table_search(teams, match->team2);
        team = item->content;
        team->record++;
        removeNode(ordered_teams, item);
        insertSorted(ordered_teams, item);
      }
      else
      {
        
      }

    }

  }

}

void getTopTeams(link ordered_teams)
{
  link node = ordered_teams;
  link next;
  Item item;
  Team team;
  if (node != 0)
  {
    item = node->item;
    team = item->content;
    printf("%d Melhores %d\n", NL, team->record);
  }
  else
  {
    
  }

  while (node != 0)
  {
    printf("%d * ", NL);
    printItemName(node->item);
    next = node->next;
    if ((next == 0) || (!equals_wins(next->item, node->item)))
    {
      return;
    }
    else
    {
      
    }

    node = next;
  }

}

