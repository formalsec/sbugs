#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include "main.h"


int main()
{
  char command;
  int NL = 0;
  GameHash_ptr game_hash = GameHashInit(11);
  Game_link game_list = 0;
  TeamHash_ptr team_hash = TeamHashInit(11);
  while ((command = getchar()) != 'x')
  {
    switch (command)
    {
      case 'a':
        NL++;
        AddGame(&game_hash, &game_list, team_hash, NL);
        break;

      case 'l':
        NL++;
        GameList(game_list, NL);
        break;

      case 'p':
        NL++;
        SearchGame(game_hash, NL);
        break;

      case 'r':
        NL++;
        DeleteGame(game_hash, &game_list, NL);
        break;

      case 's':
        NL++;
        ChangeScore(game_hash, NL);
        break;

      case 'A':
        NL++;
        AddTeam(&team_hash, NL);
        break;

      case 'P':
        NL++;
        SearchTeam(team_hash, NL);
        break;

      case 'g':
        NL++;
        SearchBestTeams(team_hash, NL);
        break;

      default:
        break;

    }

  }

  FreeAll(game_hash, game_list, team_hash);
  return 0;
}

void AddGame(GameHash_ptr *game_hash, Game_link *game_list, TeamHash_ptr team_hash, int NL)
{
  int score1;
  int score2;
  char name_buffer[1024];
  char team1_buffer[1024];
  char team2_buffer[1024];
  char *name;
  char *team1_name;
  char *team2_name;
  Game_ptr game;
  Team_ptr team1;
  Team_ptr team2;
  for (int name_buffer_index = 0; name_buffer_index < 10; name_buffer_index++)
  {
    name_buffer[name_buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  name_buffer[10 - 1] = '\0';
  for (int team1_buffer_index = 0; team1_buffer_index < 10; team1_buffer_index++)
  {
    team1_buffer[team1_buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  team1_buffer[10 - 1] = '\0';
  for (int team2_buffer_index = 0; team2_buffer_index < 10; team2_buffer_index++)
  {
    team2_buffer[team2_buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  team2_buffer[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  name = StringDup(name_buffer);
  team1_name = StringDup(team1_buffer);
  team2_name = StringDup(team2_buffer);
  if (GameHashSearch(*game_hash, name) != 0)
  {
    free(name);
    free(team1_name);
    free(team2_name);
    printf("%d Jogo existente.\n", NL);
    return;
  }
  else
  {
    
  }

  team1 = TeamHashSearch(team_hash, team1_name);
  team2 = TeamHashSearch(team_hash, team2_name);
  if ((team1 == 0) || (team2 == 0))
  {
    free(name);
    free(team1_name);
    free(team2_name);
    printf("%d Equipa inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  if (score1 > score2)
  {
    team1->wins++;
  }
  else
  {
    if (score1 < score2)
    {
      team2->wins++;
    }
    else
    {
      
    }

  }

  game = NewGame(name, team1, team2, score1, score2);
  *game_hash = GameHashInsert(*game_hash, game);
  *game_list = InsertGameBeginList(*game_list, game);
  free(name);
  free(team1_name);
  free(team2_name);
}

void AddTeam(TeamHash_ptr *team_hash, int NL)
{
  char buffer[1024];
  char *name;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = StringDup(buffer);
  if (TeamHashSearch(*team_hash, name) != 0)
  {
    free(name);
    printf("%d Equipa existente.\n", NL);
    return;
  }
  else
  {
    
  }

  *team_hash = TeamHashInsert(team_hash, NewTeam(name));
  free(name);
}

void GameList(Game_link game_list, int NL)
{
  Game_link aux;
  if (game_list != 0)
  {
    aux = game_list->prev;
    do
    {
      printf("%d ", NL);
      PrintGame(aux->game);
      aux = aux->prev;
    }
    while (aux != game_list->prev);
  }
  else
  {
    
  }

}

void SearchGame(GameHash_ptr game_hash, int NL)
{
  char buffer[1024];
  char *name;
  Game_ptr game;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = StringDup(buffer);
  game = GameHashSearch(game_hash, name);
  if (game != 0)
  {
    printf("%d ", NL);
    PrintGame(game);
  }
  else
  {
    printf("%d Jogo inexistente.\n", NL);
  }

  free(name);
}

void SearchTeam(TeamHash_ptr team_hash, int NL)
{
  char buffer[1024];
  char *name;
  Team_ptr team;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = StringDup(buffer);
  team = TeamHashSearch(team_hash, name);
  if (team != 0)
  {
    printf("%d ", NL);
    PrintTeam(team);
  }
  else
  {
    printf("%d Equipa inexistente.\n", NL);
  }

  free(name);
}

void DeleteGame(GameHash_ptr game_hash, Game_link *game_list, int NL)
{
  char buffer[1024];
  char *name;
  Game_ptr game;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = StringDup(buffer);
  game = GameHashSearch(game_hash, name);
  if (game == 0)
  {
    free(name);
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  if (game->score.score1 > game->score.score2)
  {
    game->team1->wins--;
  }
  else
  {
    if (game->score.score1 < game->score.score2)
    {
      game->team2->wins--;
    }
    else
    {
      
    }

  }

  GameHashRemove(game_hash, name);
  *game_list = RemoveGameList(*game_list, name);
  free(name);
}

void ChangeScore(GameHash_ptr game_hash, int NL)
{
  char buffer[1024];
  char *name;
  int score1;
  int score2;
  Team_ptr winner;
  Game_ptr game;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  name = StringDup(buffer);
  game = GameHashSearch(game_hash, name);
  if (game == 0)
  {
    free(name);
    printf("%d Jogo inexistente.\n", NL);
    return;
  }
  else
  {
    
  }

  winner = game_winner(game);
  if (winner != 0)
  {
    winner->wins--;
  }
  else
  {
    
  }

  game->score.score1 = score1;
  game->score.score2 = score2;
  winner = game_winner(game);
  if (winner != 0)
  {
    winner->wins++;
  }
  else
  {
    
  }

  free(name);
}

void SearchBestTeams(TeamHash_ptr team_hash, int NL)
{
  int i;
  int N = 0;
  int most_wins = -1;
  int K = 0;
  Team_ptr *best_teams = (Team_ptr *) malloc((sizeof(Team_ptr)) * team_hash->N);
  for (i = 0; i < team_hash->M; i++)
    if (team_hash->hash_table[i] != 0)
  {
    if (team_hash->hash_table[i]->wins > most_wins)
    {
      most_wins = team_hash->hash_table[i]->wins;
      K = N;
      ArrayInsert(best_teams, team_hash->hash_table[i], &N);
    }
    else
    {
      if (team_hash->hash_table[i]->wins == most_wins)
      {
        ArrayInsert(best_teams, team_hash->hash_table[i], &N);
      }
      else
      {
        
      }

    }

  }
  else
  {
    
  }


  if (N == 0)
  {
    free(best_teams);
    return;
  }
  else
  {
    
  }

  mergesort(best_teams, K, N - 1, team_hash);
  printf("%d Melhores %d\n", NL, most_wins);
  for (; K < N; K++)
    printf("%d * %s\n", NL, best_teams[K]->name);

  free(best_teams);
}

void FreeAll(GameHash_ptr game_hash, Game_link game_list, TeamHash_ptr team_hash)
{
  DeleteTeamHash(team_hash);
  DeleteGameHash(game_hash);
  DeleteGameList(game_list);
}

