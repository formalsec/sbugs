#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "functions.h"
#include "games.h"
#include "teams.h"
#include "hash.h"


int team_exists(hash_teams teams_tbl, char *team_name)
{
  return (search_team_index_in_hash(teams_tbl, team_name) != (-1)) ? (1) : (0);
}

int game_exists(hash_games games_tbl, char *game_name)
{
  return (search_game_index_in_hash(games_tbl, game_name) != (-1)) ? (1) : (0);
}

int string_cmp(const void *input_word1, const void *input_word2)
{
  const char **word1 = (const char **) input_word1;
  const char **word2 = (const char **) input_word2;
  return strcmp(*word1, *word2);
}

void adds_new_game(int lct, hash_teams teams_tbl, hash_games games_tbl, dl_list games_lst)
{
  char *name;
  char *team1;
  char *team2;
  int score1 = 0;
  int score2 = 0;
  char buffer[1024] = {0};
  match new_game;
  int winner_idx;
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  memset(buffer, 0, 1024);
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  team1 = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(team1, buffer);
  memset(buffer, 0, 1024);
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  team2 = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(team2, buffer);
  score1 = new_sym_var(sizeof(int) * 8);
  score2 = new_sym_var(sizeof(int) * 8);
  if (game_exists(games_tbl, name))
  {
    printf("%d Jogo existente.\n", lct);
    free(name);
    free(team1);
    free(team2);
  }
  else
  {
    if ((!team_exists(teams_tbl, team1)) || (!team_exists(teams_tbl, team2)))
    {
      printf("%d Equipa inexistente.\n", lct);
      free(name);
      free(team1);
      free(team2);
    }
    else
    {
      if (score1 > score2)
      {
        winner_idx = search_team_index_in_hash(teams_tbl, team1);
        teams_tbl->table[winner_idx]->value->victories++;
      }
      else
      {
        if (score1 < score2)
        {
          winner_idx = search_team_index_in_hash(teams_tbl, team2);
          teams_tbl->table[winner_idx]->value->victories++;
        }
        else
        {
          
        }

      }

      new_game = creates_match(name, team1, team2, score1, score2);
      insert_begin(games_lst, new_game);
      insert_games_hash(games_tbl, games_lst->head);
    }

  }

}

void add_new_team(int lct, hash_teams teams_tbl, sl_list teams_lst)
{
  char *name;
  fut_team new_team;
  char buffer[1024] = {0};
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  if (team_exists(teams_tbl, name))
  {
    printf("%d Equipa existente.\n", lct);
    free(name);
  }
  else
  {
    new_team = creates_team(name);
    insert_team_begin(teams_lst, new_team);
    insert_team_hash(teams_tbl, teams_lst->head);
  }

}

void lists_all_games(int lct, dl_list games_lst)
{
  int i;
  match gm;
  dl_link ite;
  int lst_size = games_lst->size;
  if (dl_list_is_empty(games_lst))
  {
    return;
  }
  else
  {
    
  }

  for (i = 0, ite = games_lst->tail; i < lst_size; i++)
  {
    gm = ite->value;
    printf("%d %s %s %s %d %d\n", lct, gm->name, gm->team1, gm->team2, gm->score1, gm->score2);
    ite = ite->previous;
  }

}

void search_game(int lct, hash_games games_tbl)
{
  char *name;
  int game_index;
  match game;
  char buffer[1024] = {0};
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  game_index = search_game_index_in_hash(games_tbl, name);
  if (game_index == (-1))
  {
    printf("%d Jogo inexistente.\n", lct);
  }
  else
  {
    game = games_tbl->table[game_index]->value;
    printf("%d %s %s %s %d %d\n", lct, game->name, game->team1, game->team2, game->score1, game->score2);
  }

  free(name);
}

void search_team(int lct, hash_teams teams_tbl)
{
  char *name;
  int team_index;
  fut_team team;
  char buffer[1024] = {0};
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  team_index = search_team_index_in_hash(teams_tbl, name);
  if (team_index == (-1))
  {
    printf("%d Equipa inexistente.\n", lct);
  }
  else
  {
    team = teams_tbl->table[team_index]->value;
    printf("%d %s %d\n", lct, team->name, team->victories);
  }

  free(name);
}

void deletes_game(int lct, hash_teams teams_tbl, hash_games games_tbl, dl_list games_lst)
{
  char *name;
  int game_index;
  match game;
  int team_idx;
  char buffer[1024] = {0};
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  game_index = search_game_index_in_hash(games_tbl, name);
  if (game_index == (-1))
  {
    printf("%d Jogo inexistente.\n", lct);
  }
  else
  {
    game = games_tbl->table[game_index]->value;
    if (game->score1 > game->score2)
    {
      team_idx = search_team_index_in_hash(teams_tbl, game->team1);
      teams_tbl->table[team_idx]->value->victories--;
    }
    else
    {
      if (game->score1 < game->score2)
      {
        team_idx = search_team_index_in_hash(teams_tbl, game->team2);
        teams_tbl->table[team_idx]->value->victories--;
      }
      else
      {
        
      }

    }

    remove_node(games_lst, games_tbl->table[game_index]);
    deletes_game_hash(games_tbl, game_index);
  }

  free(name);
}

void changes_game_score(int lct, hash_teams teams_tbl, hash_games games_tbl)
{
  char *name;
  int new_sc1 = 0;
  int new_sc2 = 0;
  match game;
  int t1_idx;
  int t2_idx;
  char buffer[1024] = {0};
  for (int buffer_index = 0; buffer_index < 10; buffer_index++)
  {
    buffer[buffer_index] = new_sym_var(sizeof(char) * 8);
  }

  buffer[10 - 1] = '\0';
  name = (char *) calloc(strlen(buffer) + 1, sizeof(char));
  strcpy(name, buffer);
  new_sc1 = new_sym_var(sizeof(int) * 8);
  new_sc2 = new_sym_var(sizeof(int) * 8);
  if (!game_exists(games_tbl, name))
  {
    printf("%d Jogo inexistente.\n", lct);
  }
  else
  {
    game = games_tbl->table[search_game_index_in_hash(games_tbl, name)]->value;
    t1_idx = search_team_index_in_hash(teams_tbl, game->team1);
    t2_idx = search_team_index_in_hash(teams_tbl, game->team2);
    if (game->score1 > game->score2)
    {
      if (new_sc1 > new_sc2)
      {
        ;
      }
      else
      {
        if (new_sc1 < new_sc2)
        {
          teams_tbl->table[t1_idx]->value->victories--;
          teams_tbl->table[t2_idx]->value->victories++;
        }
        else
        {
          teams_tbl->table[t1_idx]->value->victories--;
        }

      }

    }
    else
    {
      if (game->score1 < game->score2)
      {
        if (new_sc1 > new_sc2)
        {
          teams_tbl->table[t1_idx]->value->victories++;
          teams_tbl->table[t2_idx]->value->victories--;
        }
        else
        {
          if (new_sc1 < new_sc2)
          {
            ;
          }
          else
          {
            teams_tbl->table[t2_idx]->value->victories--;
          }

        }

      }
      else
      {
        if (new_sc1 > new_sc2)
        {
          teams_tbl->table[t1_idx]->value->victories++;
        }
        else
        {
          if (new_sc1 < new_sc2)
          {
            teams_tbl->table[t2_idx]->value->victories++;
          }
          else
          {
            ;
          }

        }

      }

    }

    game->score1 = new_sc1;
    game->score2 = new_sc2;
  }

  free(name);
}

void prints_top_teams(int lct, sl_list teams_lst)
{
  int i;
  int j;
  int max[2] = {0, 0};
  int lst_size = teams_lst->size;
  sl_link node;
  fut_team team;
  char **bag_teams;
  if (sl_list_is_empty(teams_lst))
  {
    return;
  }
  else
  {
    
  }

  for (i = 0, node = teams_lst->head; i < lst_size; i++, node = node->next)
  {
    team = node->value;
    if (team->victories > max[0])
    {
      max[0] = team->victories;
      max[1] = 1;
    }
    else
    {
      if (team->victories == max[0])
      {
        max[1]++;
      }
      else
      {
        
      }

    }

  }

  bag_teams = (char **) calloc(max[1], sizeof(char *));
  for (i = 0, node = teams_lst->head, j = 0; i < lst_size; i++, node = node->next)
  {
    team = node->value;
    if (team->victories == max[0])
    {
      bag_teams[j++] = team->name;
    }
    else
    {
      
    }

  }

  qsort(bag_teams, max[1], sizeof(char *), string_cmp);
  printf("%d Melhores %d\n", lct, max[0]);
  for (i = 0; i < max[1]; ++i)
  {
    printf("%d * %s\n", lct, bag_teams[i]);
  }

  free(bag_teams);
}

