#include "/home/fmarques/sbugs/projects/alunos/lib/stubs.h"
/*File generated by PreProcessor.py*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "trees.h"
#include "lists.h"
#include "teams.h"
#include "games.h"


void add_game(t_node *, t_node **, t_node **, list *, int);
void add_team(t_node **, t_node **, int);
void list_games(list *, int);
void search_game(t_node *, int);
void search_team(t_node *, int);
void search_print(t_node *, int, void (*print)(void *, int), int);
void remove_game(t_node **, t_node **, list **, int);
void change_score(t_node *, t_node **, int);
void print_winners(t_node *, int);
int main()
{
  char cmd;
  int in_line = 1;
  t_node *t_teams_v;
  t_node *t_teams_n;
  t_node *t_games;
  list *l_games;
  t_teams_v = (t_teams_n = (t_games = 0));
  l_games = list_init();
  do
  {
    cmd = getchar();
    switch (cmd)
    {
      case 'a':
        add_game(t_teams_n, &t_teams_v, &t_games, l_games, in_line);
        break;

      case 'A':
        add_team(&t_teams_n, &t_teams_v, in_line);
        break;

      case 'l':
        list_games(l_games, in_line);
        break;

      case 'p':
        search_game(t_games, in_line);
        break;

      case 'P':
        search_team(t_teams_n, in_line);
        break;

      case 'r':
        remove_game(&t_games, &t_teams_v, &l_games, in_line);
        break;

      case 's':
        change_score(t_games, &t_teams_v, in_line);
        break;

      case 'g':
        print_winners(t_teams_v, in_line);
        break;

    }

    in_line++;
  }
  while (cmd != 'x');
  destroy_tree(t_teams_v, del_team);
  free_tree(t_teams_n);
  free_tree(t_games);
  destroy_list(l_games, del_game);
  return 0;
}

void add_game(t_node *t_teams_n, t_node **t_teams_v, t_node **t_games, list *l_games, int i_l)
{
  char g_name[1024];
  char t1_name[1024];
  char t2_name[1024];
  short score1;
  short score2;
  team *t1;
  team *t2;
  lst_node *g_nd;
  game *new_g;
  for (int g_name_index = 0; g_name_index < 10; g_name_index++)
  {
    g_name[g_name_index] = new_sym_var(sizeof(char) * 8);
  }

  g_name[10 - 1] = '\0';
  for (int t1_name_index = 0; t1_name_index < 10; t1_name_index++)
  {
    t1_name[t1_name_index] = new_sym_var(sizeof(char) * 8);
  }

  t1_name[10 - 1] = '\0';
  for (int t2_name_index = 0; t2_name_index < 10; t2_name_index++)
  {
    t2_name[t2_name_index] = new_sym_var(sizeof(char) * 8);
  }

  t2_name[10 - 1] = '\0';
  score1 = new_sym_var(sizeof(short) * 8);
  score2 = new_sym_var(sizeof(short) * 8);
  getchar();
  if (tree_lookup(*t_games, cmp_game_str, g_name) != 0)
  {
    printf("%d Jogo existente.\n", i_l);
    return;
  }
  else
  {
    
  }

  t1 = tree_lookup(t_teams_n, cmp_team_str, t1_name);
  t2 = tree_lookup(t_teams_n, cmp_team_str, t2_name);
  if ((t1 == 0) || (t2 == 0))
  {
    printf("%d Equipa inexistente.\n", i_l);
    return;
  }
  else
  {
    
  }

  if (score1 > score2)
  {
    *t_teams_v = change_victs(*t_teams_v, t1, 1);
  }
  else
  {
    if (score2 > score1)
    {
      *t_teams_v = change_victs(*t_teams_v, t2, 1);
    }
    else
    {
      
    }

  }

  new_g = malloc(sizeof(game));
  new_g->name = strdup(g_name);
  new_g->team1 = t1;
  new_g->team2 = t2;
  new_g->score1 = score1;
  new_g->score2 = score2;
  g_nd = list_append(l_games, new_g);
  *t_games = tree_insert(*t_games, cmp_game_nds, g_nd);
  return;
}

void add_team(t_node **t_teams_n, t_node **t_teams_v, int in_line)
{
  char t_name[1024];
  team *new_t;
  for (int t_name_index = 0; t_name_index < 10; t_name_index++)
  {
    t_name[t_name_index] = new_sym_var(sizeof(char) * 8);
  }

  t_name[10 - 1] = '\0';
  getchar();
  if (tree_lookup(*t_teams_n, cmp_team_str, t_name) != 0)
  {
    printf("%d Equipa existente.\n", in_line);
    return;
  }
  else
  {
    
  }

  new_t = malloc(sizeof(team));
  new_t->name = strdup(t_name);
  new_t->victs = 0;
  *t_teams_n = tree_insert(*t_teams_n, cmp_teams_nme, new_t);
  *t_teams_v = tree_insert(*t_teams_v, cmp_teams_vct, new_t);
  return;
}

void list_games(list *lst, int in_line)
{
  lst_node *cursor = lst->head;
  getchar();
  while (cursor != 0)
  {
    print_game(cursor->value, in_line);
    cursor = cursor->next;
  }

  return;
}

void search_game(t_node *t_games, int in_line)
{
  char g_name[1024];
  lst_node *g_nd;
  for (int g_name_index = 0; g_name_index < 10; g_name_index++)
  {
    g_name[g_name_index] = new_sym_var(sizeof(char) * 8);
  }

  g_name[10 - 1] = '\0';
  getchar();
  g_nd = tree_lookup(t_games, cmp_game_str, g_name);
  if (g_nd == 0)
  {
    printf("%d Jogo inexistente.\n", in_line);
    return;
  }
  else
  {
    
  }

  print_game(g_nd->value, in_line);
  return;
}

void search_team(t_node *t_teams_n, int in_line)
{
  char t_name[1024];
  team *t;
  for (int t_name_index = 0; t_name_index < 10; t_name_index++)
  {
    t_name[t_name_index] = new_sym_var(sizeof(char) * 8);
  }

  t_name[10 - 1] = '\0';
  getchar();
  t = tree_lookup(t_teams_n, cmp_team_str, t_name);
  if (t == 0)
  {
    printf("%d Equipa inexistente.\n", in_line);
    return;
  }
  else
  {
    
  }

  print_team(t, in_line);
  return;
}

void remove_game(t_node **t_games, t_node **t_teams_v, list **l, int in_line)
{
  char g_name[1024];
  lst_node *g_nd;
  game *g;
  for (int g_name_index = 0; g_name_index < 10; g_name_index++)
  {
    g_name[g_name_index] = new_sym_var(sizeof(char) * 8);
  }

  g_name[10 - 1] = '\0';
  getchar();
  g_nd = tree_lookup(*t_games, cmp_game_str, g_name);
  if (g_nd == 0)
  {
    printf("%d Jogo inexistente.\n", in_line);
    return;
  }
  else
  {
    
  }

  g = g_nd->value;
  if (g->score1 > g->score2)
  {
    *t_teams_v = change_victs(*t_teams_v, g->team1, -1);
  }
  else
  {
    if (g->score1 < g->score2)
    {
      *t_teams_v = change_victs(*t_teams_v, g->team2, -1);
    }
    else
    {
      
    }

  }

  *t_games = tree_remove(*t_games, cmp_game_nds, g_nd);
  del_game(g);
  *l = remove_node(*l, g_nd);
  return;
}

void change_score(t_node *t_games, t_node **t_teams_v, int in_line)
{
  char g_name[1024];
  short n_scr1;
  short n_scr2;
  lst_node *g_nd;
  game *g;
  for (int g_name_index = 0; g_name_index < 10; g_name_index++)
  {
    g_name[g_name_index] = new_sym_var(sizeof(char) * 8);
  }

  g_name[10 - 1] = '\0';
  n_scr1 = new_sym_var(sizeof(short) * 8);
  n_scr2 = new_sym_var(sizeof(short) * 8);
  getchar();
  g_nd = tree_lookup(t_games, cmp_game_str, g_name);
  if (g_nd == 0)
  {
    printf("%d Jogo inexistente.\n", in_line);
    return;
  }
  else
  {
    
  }

  g = g_nd->value;
  if ((g->score1 > g->score2) && (n_scr1 <= n_scr2))
  {
    *t_teams_v = change_victs(*t_teams_v, g->team1, -1);
  }
  else
  {
    if ((g->score1 <= g->score2) && (n_scr1 > n_scr2))
    {
      *t_teams_v = change_victs(*t_teams_v, g->team1, 1);
    }
    else
    {
      
    }

  }

  if ((g->score1 < g->score2) && (n_scr1 >= n_scr2))
  {
    *t_teams_v = change_victs(*t_teams_v, g->team2, -1);
  }
  else
  {
    if ((g->score1 >= g->score2) && (n_scr1 < n_scr2))
    {
      *t_teams_v = change_victs(*t_teams_v, g->team2, 1);
    }
    else
    {
      
    }

  }

  g->score1 = n_scr1;
  g->score2 = n_scr2;
  return;
}

void print_winners(t_node *t_teams_v, int in_line)
{
  t_node *max;
  short max_victs;
  getchar();
  if (t_teams_v == 0)
  {
    return;
  }
  else
  {
    
  }

  max = max_node(t_teams_v);
  max_victs = ((team *) max->value)->victs;
  printf("%d Melhores %hd\n", in_line, max_victs);
  print_targets(t_teams_v, max_victs, in_line);
  return;
}

